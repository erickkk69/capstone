<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barangay Secretary Portal</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 0;
    }

    header {
      background: #004c99;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000; 
      box-sizing: border-box;
      height: 70px; 
    }

    .header-left, .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      height: 50px; 
      width: auto;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      background: white;
      color: black;
      padding: 5px 10px;
      border-radius: 20px;
    }

    .main-layout {
      display: flex;
      margin-top: 70px; 
      min-height: calc(100vh - 70px);
    }

    .sidebar {
      width: 250px;
      background: #e0e0e0;
      padding-top: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      position: fixed; 
      top: 70px; 
      left: 0;
      height: calc(100vh - 70px); 
      overflow-y: auto; 
      z-index: 999;
    }

    .sidebar a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 18px;
      text-decoration: none;
      color: #222;
      font-weight: 600;
      border-left: 5px solid transparent;
      transition: background 0.12s, color 0.12s;
    }

    .sidebar a:hover, .sidebar a.active {
      background: #cfe4ff;
      color: #003a80;
      border-left: 5px solid #0066cc;
    }

    .sidebar:hover a.active {
      background: transparent;
      border-left: 5px solid transparent;
    }

    .sidebar:hover a.active:hover {
      background: #c0c0c0;
      border-left: 5px solid #0066cc;
    }

    .content-area {
      flex-grow: 1;
      padding: 20px;
      margin-left: 250px; 
    }

    .sidebar .icon {
      width: 20px;
      height: 20px;
      display: inline-block;
      flex: 0 0 20px;
      color: inherit;
    }
    .sidebar .icon svg { display: block; width: 100%; height: 100%; }

    @media (max-width: 800px) {
      .sidebar {
        position: relative;
        width: 100%;
        height: auto;
        display: flex;
        gap: 8px;
        padding: 8px;
        overflow: visible;
      }
      .main-layout { flex-direction: column; margin-top: 70px; }
      .content-area { margin-left: 0; }
      .sidebar a { padding: 10px; }
    }

    .card {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .card:not(.active-card) {
      display: none;
    }

    h2 {
      margin-top: 0;
      color: #004c99;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    
    .dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    
    .notifications-card {
        padding: 20px;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        max-height: 500px;
        overflow-y: auto;
        overflow-x: hidden;
    }
    
    .notifications-card::-webkit-scrollbar {
        width: 8px;
    }
    
    .notifications-card::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .notifications-card::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    
    .notifications-card::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    input[type="text"], input[type="file"], select {
      display: block;
      margin: 0;
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus {
        border-color: #0066cc;
        outline: none;
    }

    button {
      background: #0066cc;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 20px;
      padding: 12px;
      font-weight: bold;
      border-radius: 6px; 
      transition: background 0.3s;
      position: relative;
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    button.loading {
      color: transparent;
      pointer-events: none;
    }
    
    button.loading::after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spinner 0.8s linear infinite;
    }
    
    @keyframes spinner {
      to {
        transform: rotate(360deg);
      }
    }
    
    #view-all-button-container { 
        text-align: right; 
        margin-top: 15px;
    }

    #view-all-button {
        display: inline-block; 
        width: auto; 
        margin-top: 0; 
    }

    button:hover {
      background: #004c99;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    th {
      background-color: #f0f0f0;
      color: #333;
      font-weight: bold;
      text-align: left;
      padding: 12px 10px;
      border-bottom: 2px solid #ccc;
    }

    td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    tr:hover {
        background-color: #f9f9f9;
    }
    
    .status-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 0.85em;
      text-align: center;
    }

    /* Sidebar notification badge */
    .sidebar-notif-badge {
      background-color: #dc3545;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7em;
      font-weight: bold;
      margin-left: auto;
      display: none;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }

    .sidebar a {
      position: relative;
    }

    .status-approved {
      background-color: #d4edda;
      color: #155724;
    }

    .status-pending {
      background-color: #cce5ff;
      color: #004085;
    }

    .status-review {
      background-color: #fff3cd;
      color: #856404;
    }

    .status-rejected {
      background-color: #f8d7da;
      color: #721c24;
    }

    /* Comment-related styles */
    .comment-indicator {
      color: #28a745;
      font-size: 0.9em;
      margin-left: 5px;
    }

    .comment-button {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
      margin-left: 5px;
      text-decoration: none;
      display: inline-block;
    }

    .comment-button:hover {
      background: #138496;
      color: white;
      text-decoration: none;
    }

    .comment-preview {
      font-size: 0.85em;
      color: #6c757d;
      font-style: italic;
      margin-top: 3px;
      padding: 3px 0;
      border-top: 1px solid #e9ecef;
    }

    .comment-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .comment-modal-content {
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 700px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .comment-entry {
      background: #f8f9fa;
      padding: 12px;
      margin: 8px 0;
      border-radius: 6px;
      border-left: 4px solid #007bff;
    }

    .comment-timestamp {
      font-size: 0.85em;
      color: #6c757d;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .comment-text {
      color: #495057;
      line-height: 1.4;
    }

    /* Status Filter Buttons */
    .status-filter-btn {
      padding: 8px 16px;
      border: 2px solid #ddd;
      background-color: #f8f9fa;
      color: #495057;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.2s ease;
      white-space: nowrap;
      margin-bottom: 5px;
    }

    .status-filter-btn:hover {
      background-color: #e9ecef;
      border-color: #007bff;
    }

    .status-filter-btn.active {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }

    .status-filter-btn.active:hover {
      background-color: #0056b3;
      border-color: #0056b3;
    }

    .dashboard-stats {
        display: flex;
        justify-content: space-around;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .stat-box {
        flex: 1;
        min-width: 150px;
        padding: 15px;
        text-align: center;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        background: #f7f7f7;
    }

    .stat-box h3 {
        margin: 0 0 5px 0;
        font-size: 1em;
        color: #666;
    }

    .stat-box p {
        margin: 0;
        font-size: 1.8em;
        font-weight: bold;
        color: #0066cc;
    }

    .notif {
      background: #fff;
      padding: 10px 15px;
      border-left: 5px solid #0066cc;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      font-size: 0.95em;
    }
    
    .notif-timestamp {
        display: block;
        font-size: 0.8em;
        color: #777;
        margin-top: 5px;
        text-align: right;
    }
    
    .form-row {
      display: flex;
      gap: 20px;
      margin-top: 15px;
    }

    .form-column {
      flex: 1;
    }

    .form-column label {
      margin-top: 0;
    }

    /* Document Viewer Modal */
    .doc-viewer-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .doc-viewer-container {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 1200px;
        height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .doc-viewer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 2px solid #e0e0e0;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
    }

    .doc-viewer-title {
        font-size: 1.1em;
        font-weight: bold;
        color: #004c99;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-right: 15px;
    }

    .doc-viewer-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .doc-viewer-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .doc-viewer-download {
        background: #28a745;
        color: white;
        text-decoration: none;
    }

    .doc-viewer-download:hover {
        background: #218838;
    }

    .doc-viewer-close {
        background: #dc3545;
        color: white;
    }

    .doc-viewer-close:hover {
        background: #c82333;
    }

    .doc-viewer-content {
        flex: 1;
        overflow: hidden;
        position: relative;
        background: #f5f5f5;
    }

    .doc-viewer-iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    .doc-viewer-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #666;
    }

    .doc-viewer-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #004c99;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Custom Alert Modal */
    .custom-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 99999;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideDown {
        from { 
            transform: translateY(-30px);
            opacity: 0;
        }
        to { 
            transform: translateY(0);
            opacity: 1;
        }
    }

    .custom-modal-content {
        background: white;
        border-radius: 12px;
        padding: 0;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: slideDown 0.3s ease-out;
        overflow: hidden;
    }

    .custom-modal-header {
        background: linear-gradient(135deg, #004c99 0%, #0066cc 100%);
        color: white;
        padding: 20px 25px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .custom-modal-header.success {
        background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);
    }

    .custom-modal-header.error {
        background: linear-gradient(135deg, #dc3545 0%, #e74c5c 100%);
    }

    .custom-modal-header.warning {
        background: linear-gradient(135deg, #ffc107 0%, #ffcd39 100%);
    }

    .custom-modal-icon {
        font-size: 28px;
        line-height: 1;
    }

    .custom-modal-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
        flex: 1;
    }

    .custom-modal-body {
        padding: 25px;
        color: #333;
        font-size: 15px;
        line-height: 1.6;
        max-height: 400px;
        overflow-y: auto;
    }

    .custom-modal-footer {
        padding: 15px 25px;
        background: #f8f9fa;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        border-top: 1px solid #e0e0e0;
    }

    .custom-modal-button {
        padding: 10px 24px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 80px;
    }

    .custom-modal-button.primary {
        background: #004c99;
        color: white;
    }

    .custom-modal-button.primary:hover {
        background: #003d7a;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 76, 153, 0.3);
    }

    .custom-modal-button.success {
        background: #28a745;
        color: white;
    }

    .custom-modal-button.success:hover {
        background: #218838;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    /* Notification Bell Styles */
    .notification-bell {
        position: relative;
        cursor: pointer;
        margin-right: 15px;
    }

    .notification-bell svg {
        width: 28px;
        height: 28px;
        fill: white;
        transition: transform 0.2s;
    }

    .notification-bell:hover svg {
        transform: scale(1.1);
    }

    .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7em;
        font-weight: bold;
        display: none;
        animation: pulse 2s infinite;
    }

    .notification-badge.show {
        display: flex;
    }

    .notification-dropdown {
        position: absolute;
        top: 60px;
        right: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        width: 400px;
        max-height: 500px;
        z-index: 10000;
        display: none;
        overflow: hidden;
    }

    .notification-dropdown.show {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .notification-dropdown-header {
        padding: 15px 20px;
        border-bottom: 2px solid #eee;
        background: #f8f9fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .notification-dropdown-header h3 {
        margin: 0;
        font-size: 1.1em;
        color: #333;
    }

    .mark-all-read {
        background: none;
        border: none;
        color: #0066cc;
        cursor: pointer;
        font-size: 0.9em;
        padding: 0;
        margin: 0;
    }

    .mark-all-read:hover {
        color: #22ff00;
        background: none;
        border: none;
    }

    .notification-dropdown-body {
        max-height: 400px;
        overflow-y: auto;
    }

    .notification-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
        position: relative;
    }

    .notification-item:hover {
        background: #f8f9fa;
    }

    .notification-item.unread {
        background: #fff9e6;
        border-left: 4px solid #ffc107;
    }

    .notification-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 5px;
    }

    .notification-item-title {
        font-weight: bold;
        color: #004c99;
        font-size: 0.95em;
        flex: 1;
        margin-right: 10px;
    }

    .notification-item-actions {
        display: flex;
        gap: 8px;
    }

    .notification-item-action {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2em;
        padding: 0;
        margin: 0;
        opacity: 0.6;
        transition: opacity 0.2s, transform 0.2s;
    }

    .notification-item-action:hover {
        opacity: 1;
        transform: scale(1.2);
    }

    .notification-item-content {
        font-size: 0.85em;
        color: #666;
        margin-bottom: 5px;
        line-height: 1.4;
    }

    .notification-item-time {
        font-size: 0.75em;
        color: #999;
    }

    .notification-empty {
        padding: 40px 20px;
        text-align: center;
        color: #999;
    }

    .notification-empty svg {
        width: 60px;
        height: 60px;
        fill: #ddd;
        margin-bottom: 10px;
    }

  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <img src="images/Mbnlg.png" alt="Barangay Logo" class="logo">
      <h1 id="portalTitle">Barangay Secretary Portal</h1>
    </div>
    <div class="header-right">
      <!-- Notification Bell -->
      <div class="notification-bell" id="notificationBell" onclick="toggleNotificationDropdown()">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
        </svg>
        <span class="notification-badge" id="notificationBadge">0</span>
      </div>
      
      <div class="user-info">
        <span id="userInfoText">Barangay Secretary</span>
      </div>
    </div>
  </header>

  <!-- Notification Dropdown -->
  <div class="notification-dropdown" id="notificationDropdown">
    <div class="notification-dropdown-header">
      <h3>Notifications</h3>
      <button class="mark-all-read" onclick="markAllAnnouncementsAsRead()">Mark all as read</button>
    </div>
    <div class="notification-dropdown-body" id="notificationDropdownBody">
      <div class="notification-empty">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
        </svg>
        <p>No new notifications</p>
      </div>
    </div>
  </div>

  <div class="main-layout">
    <nav class="sidebar">
      <a href="#dashboard" class="sidebar-link active" data-target="dashboard">
        <span class="icon" aria-hidden="true">
          <!-- Dashboard icon -->
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
            <rect x="3" y="3" width="8" height="8" fill="currentColor" rx="1" />
            <rect x="13" y="3" width="8" height="5" fill="currentColor" rx="1" opacity="0.95" />
            <rect x="13" y="10" width="8" height="11" fill="currentColor" rx="1" opacity="0.9" />
            <rect x="3" y="13" width="8" height="7" fill="currentColor" rx="1" opacity="0.9" />
          </svg>
        </span>
        Dashboard
      </a>

      <a href="#upload-document" class="sidebar-link" data-target="upload-document">
        <span class="icon" aria-hidden="true">
          <!-- Upload icon -->
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="currentColor" />
            <path d="M19 15v4H5v-4H3v4c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-4h-2z" fill="currentColor" opacity="0.9" />
          </svg>
        </span>
        Upload Document
      </a>

      <a href="#submissions" class="sidebar-link" data-target="submissions">
        <span class="icon" aria-hidden="true">
          <!-- Submissions icon -->
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
            <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z" fill="currentColor" opacity="0.9" />
            <path d="M14 2l6 6h-6V2z" fill="currentColor" />
          </svg>
        </span>
        Submissions
        <span class="sidebar-notif-badge" id="submissionsNotifBadge">0</span>
      </a>

      <a href="#announcements" class="sidebar-link" data-target="announcements">
        <span class="icon" aria-hidden="true">
          <!-- Announcements icon -->
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
            <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z" fill="currentColor" />
          </svg>
        </span>
        Announcements
        <span class="sidebar-notif-badge" id="announcementsNotifBadge">0</span>
      </a>

      <a href="index.html" class="sidebar-link" id="logout-link">
        <span class="icon" aria-hidden="true">
          <!-- Logout icon -->
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
            <path d="M16 13v-2H7V8l-5 4 5 4v-3z" fill="currentColor" />
            <path d="M20 3h-8v2h8v14h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z" fill="currentColor" opacity="0.95" />
          </svg>
        </span>
        Logout
      </a>
    </nav>

    <div class="content-area">
      
      <div id="dashboard" class="card active-card">
        <h2>Dashboard Overview</h2>
        
        <div class="dashboard-stats">
            <div class="stat-box">
                <h3>Total Submissions</h3>
                <p id="total-submissions">0</p>
            </div>
            <div class="stat-box">
                <h3>Approved</h3>
                <p id="approved-count">0</p>
            </div>
            <div class="stat-box">
                <h3>Under Review</h3>
                <p id="review-count">0</p>
            </div>
            <div class="stat-box">
                <h3>Pending/Submitted</h3>
                <p id="pending-count">0</p>
            </div>
            <div class="stat-box">
                <h3>Rejected</h3>
                <p id="rejected-count">0</p>
            </div>
        </div>
        <p style="font-style: italic; color: #666;">Summary of document processing status.</p>

        <div class="dashboard-grid">
             <div>
                 <h2 style="margin-top: 20px;">Quick Access</h2>
                <div class="quick-access-card" style="padding: 15px; border-left: 5px solid #0066cc; margin-bottom: 10px; cursor: pointer; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);" onclick="showContent('upload-document')">
                    <h3 style="margin-top: 0;">üì§ Submit New Report</h3>
                    <p style="margin-bottom: 0;">Quick access to <a href="#" onclick="showContent('upload-document'); return false;">Upload Document</a> to create and submit new reports.</p>
                </div>
                 <div class="quick-access-card" style="padding: 15px; border-left: 5px solid #28a745; margin-bottom: 10px; cursor: pointer; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);" onclick="showContent('submissions')">
                    <h3 style="margin-top: 0;">üìã View All Submissions</h3>
                    <p style="margin-bottom: 0;">View the complete list of submitted documents on the <a href="#" onclick="showContent('submissions'); return false;">My Submissions</a> page.</p>
                </div>
                <div class="quick-access-card" style="padding: 15px; border-left: 5px solid #ffc107; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <h3 style="margin-top: 0;">üìä Recent Activity</h3>
                    <p id="recent-activity-text" style="margin-bottom: 0; color: #666;">No activity</p>
                </div>
            </div>

            <div id="notifications-dashboard" class="notifications-card">
              <h2>Recent Notifications</h2>
              <div id="notifications-container">
                <div class="notif">No new notifications <span class="notif-timestamp">--</span></div>
                </div>
            </div>
        </div>

      </div>
      
      <div id="upload-document" class="card">
        <h2>Upload Official Report</h2>
        <p style="color: #555;">Create and submit official reports using the document template.</p>
        
        <div style="text-align: center; padding: 40px 20px;">
          <button type="button" onclick="window.location.href='template.html'" 
                  style="background: #0066cc; color: white; border: none; cursor: pointer; padding: 15px 40px; font-size: 16px; font-weight: bold; border-radius: 8px; transition: background 0.3s;">
            üìÑ Create a Report
          </button>
          <p style="margin-top: 15px; color: #666; font-size: 14px;">Click the button above to open the report template and fill out your document.</p>
        </div>
      </div>
      
      <div id="submissions" class="card">
        <div id="submissions-section">
        <h2>Document Submissions Management</h2>
        
        <!-- Type Filter Tabs (Active/Archived) -->
        <div style="margin-bottom: 15px; display: flex; gap: 10px;">
          <button id="filter-active" class="type-filter-btn active" onclick="filterSubmissionsByType('active')" style="padding: 10px 20px; border: 2px solid #0066cc; background: #0066cc; color: white; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
            Active Submissions
          </button>
          <button id="filter-archived" class="type-filter-btn" onclick="filterSubmissionsByType('archived')" style="padding: 10px 20px; border: 2px solid #666; background: white; color: #666; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
            Archived (<span id="archived-count-badge">0</span>)
          </button>
        </div>
        
        <!-- Status Filter Tabs -->
        <div id="status-filters" style="margin-bottom: 20px; display: flex; gap: 5px; flex-wrap: wrap;">
          <button id="filter-all" class="status-filter-btn active" onclick="filterSubmissionsByStatus('all')">
            All Submissions (<span id="count-all">0</span>)
          </button>
          <button id="filter-pending" class="status-filter-btn" onclick="filterSubmissionsByStatus('pending')">
            Pending (<span id="count-pending-filter">0</span>)
          </button>
          <button id="filter-review" class="status-filter-btn" onclick="filterSubmissionsByStatus('review')">
            Under Review (<span id="count-review-filter">0</span>)
          </button>
          <button id="filter-approved" class="status-filter-btn" onclick="filterSubmissionsByStatus('approved')">
            Approved (<span id="count-approved-filter">0</span>)
          </button>
          <button id="filter-rejected" class="status-filter-btn" onclick="filterSubmissionsByStatus('rejected')">
            Rejected (<span id="count-rejected-filter">0</span>)
          </button>
        </div>
        
        <!-- Search and Actions Bar -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <input 
            type="text" 
            id="submission-search" 
            placeholder="Search by title, category, or status..." 
            style="flex: 1; margin: 0; min-width: 250px;"
          />
          <button id="clear-search-button" type="button" style="width: auto; padding: 10px 20px; margin: 0; background-color: #ffcccc; color: #000; border: none; cursor: pointer; border-radius: 6px; font-weight: bold;" 
            onmouseover="this.style.backgroundColor='#ff0000'; this.style.color='#fff';" 
            onmouseout="this.style.backgroundColor='#ffcccc'; this.style.color='#000';">Clear Search</button>
        </div>
        
        <table>
          <thead>
            <tr>
              <th>Document Title</th>
              <th>Category</th>
              <th>Date Submitted</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="submissions-table-body">
            <!-- Submissions will be loaded dynamically -->
            </tbody>
        </table>
        
        <div id="view-all-button-container"> 
            <button id="view-all-button" type="button">View All Submissions</button>
        </div>
        
        </div>
        <!-- End of submissions-section -->
      </div>

      <!-- Announcements Section -->
      <div id="announcements" class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <div>
            <h2 style="margin: 0;">Announcements</h2>
            <p style="color: #666; margin: 5px 0 0 0;">Stay updated with important announcements from ABC</p>
          </div>
          <button id="show-hidden-announcements-btn" onclick="toggleHiddenAnnouncements()" style="display: none; background: #00ff1e; padding: 8px 16px; margin: 0;">
            Show Hidden (<span id="hidden-count">0</span>)
          </button>
        </div>
        
        <div id="announcements-list" style="min-height: 100px;">
          <div style="text-align: center; padding: 40px; color: #999;">
            <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
            <p>Loading announcements...</p>
          </div>
        </div>
      </div>

      <!-- Archived Documents Section -->
      <div id="archived" class="card">
        <h2>Archived Documents</h2>
        
        <!-- Search Bar -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
          <input 
            type="text" 
            id="archived-search" 
            placeholder="Search archived documents..." 
            style="flex: 1; margin: 0;"
          />
          <button id="clear-archived-search-button" type="button" style="width: auto; padding: 10px 20px; margin: 0; background-color: #ffcccc; color: #000; border: none; cursor: pointer; border-radius: 6px; font-weight: bold;" 
            onmouseover="this.style.backgroundColor='#ff0000'; this.style.color='#fff';" 
            onmouseout="this.style.backgroundColor='#ffcccc'; this.style.color='#000';">Clear</button>
        </div>
        
        <table>
          <thead>
            <tr>
              <th>Document Title</th>
              <th>Category</th>
              <th>Date Submitted</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="archived-table-body">
            <!-- Archived submissions will be loaded dynamically -->
            </tbody>
        </table>
        
        <div id="view-all-archived-button-container"> 
            <button id="view-all-archived-button" type="button">View All Archived</button>
        </div>
        
      </div>
      
    </div>
  </div>

  <script>
  
  // Debounce utility for button clicks - prevents multiple rapid clicks
  function debounce(func, wait = 300) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  // Button state management - prevents double-clicks
  const buttonStates = new Map();
  
  function isButtonBusy(buttonElement) {
    return buttonStates.get(buttonElement) === true;
  }
  
  function setButtonBusy(buttonElement, isBusy) {
    if (isBusy) {
      buttonStates.set(buttonElement, true);
      buttonElement.disabled = true;
      buttonElement.classList.add('loading');
      buttonElement.style.cursor = 'wait';
    } else {
      buttonStates.delete(buttonElement);
      buttonElement.disabled = false;
      buttonElement.classList.remove('loading');
      buttonElement.style.cursor = 'pointer';
    }
  }

  // Helper function to update sidebar notification badges
  function updateSidebarBadge(badgeId, count) {
    const badge = document.getElementById(badgeId);
    if (badge) {
      if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    let loggedInUser = null;
    const userInfoText = document.getElementById('userInfoText');
    const portalTitle = document.getElementById('portalTitle');
    const logoutLink = document.getElementById('logout-link');

    async function resolveUser() {
      // 1) Try client storage
      try {
        const fromStorage = sessionStorage.getItem('loggedInUser');
        if (fromStorage) {
          const parsed = JSON.parse(fromStorage);
          if (parsed && parsed.role === 'Barangay Secretary') return parsed;
        }
      } catch {}
      // 2) Fallback: ask backend session
      try {
        const res = await fetch('api/me.php');
        if (res.ok) {
          const data = await res.json();
          if (data && data.ok && data.user && data.user.role === 'Barangay Secretary') {
            try { sessionStorage.setItem('loggedInUser', JSON.stringify(data.user)); } catch {}
            return data.user;
          }
        }
      } catch {}
      return null;
    }

    (async () => {
      loggedInUser = await resolveUser();
      if (!loggedInUser) {
        showCustomAlert('Access Denied. Please login as Barangay Secretary.', 'error', function() {
          window.location.href = 'index.html';
        });
        return;
      }

      // Update the header based on user
      userInfoText.textContent = `${loggedInUser.barangay}`;
      portalTitle.textContent = `${loggedInUser.barangay} Portal`;
      // Clear session storage on logout with confirmation
      logoutLink.addEventListener('click', async (e) => {
        e.preventDefault(); // Prevent default navigation
        
        // Show custom confirmation alert
        const confirmed = await showCustomConfirm(
          'Are you sure you want to logout from the Barangay Secretary Portal?',
          'warning'
        );
        
        if (confirmed) {
          // Best-effort logout on backend
          try { 
            await fetch('api/logout.php', { method: 'POST' }); 
          } catch {}
          
          // Clear session storage
          sessionStorage.removeItem('loggedInUser');
          
          // Show logout success message and redirect
          showCustomAlert('You have been logged out successfully.', 'success', function() {
            window.location.href = 'index.html';
          });
        }
      });

        const sidebarLinks = document.querySelectorAll('.sidebar a.sidebar-link:not(#logout-link)');
        const contentCards = document.querySelectorAll('.content-area .card');
        
        // Store all submissions globally for search/filter - MUST BE DECLARED BEFORE USE
        let allSubmissions = [];
        let allArchivedSubmissions = [];
        let showingAllSubmissions = false;
        let currentStatusFilter = 'all';
        let currentTypeFilter = 'active'; // 'active' or 'archived'

        function showContent(targetId) {

            contentCards.forEach(card => {
                card.classList.remove('active-card');
            });

            document.querySelectorAll('.sidebar a').forEach(link => {
                link.classList.remove('active');
            });

            const targetCard = document.getElementById(targetId);
            if (targetCard) {
                targetCard.classList.add('active-card');
            }
            
            const activeLink = document.querySelector(`.sidebar a[data-target="${targetId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // Load announcements when announcements tab is clicked
            if (targetId === 'announcements') {
                loadAnnouncements();
            }
            
            // When viewing submissions page, mark currently displayed submissions as viewed
            if (targetId === 'submissions') {
                setTimeout(() => {
                    allSubmissions.forEach(sub => {
                        const status = sub.status ? sub.status.toLowerCase().trim() : '';
                        if (status === 'approved' || status === 'rejected' || status === 'review') {
                            // Only mark as viewed with current status - if status changes later, it will show again
                            markSubmissionAsViewed(sub.id, status);
                        }
                    });
                    // Recalculate badge count after marking as viewed
                    const unviewedCount = allSubmissions.filter(s => {
                        const status = s.status ? s.status.toLowerCase().trim() : '';
                        const hasStatusChange = status === 'approved' || status === 'rejected' || status === 'review';
                        const notViewed = !isSubmissionViewed(s.id, status);
                        return hasStatusChange && notViewed;
                    }).length;
                    updateSidebarBadge('submissionsNotifBadge', unviewedCount);
                }, 500);
            }
        }

        window.showContent = showContent;

        sidebarLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault(); 

                const targetId = event.currentTarget.getAttribute('data-target');
                showContent(targetId);
            });
        });
      
      // Function to update Recent Notifications panel
      function updateRecentNotifications(submissions) {
        const notificationsContainer = document.getElementById('notifications-container');
        
        if (!submissions || submissions.length === 0) {
          notificationsContainer.innerHTML = '<div class="notif">No new notifications <span class="notif-timestamp">--</span></div>';
          return;
        }
        
        // Filter submissions with status updates (not pending and not empty)
        const notificationItems = submissions
          .filter(s => {
            const hasStatus = s.status && s.status.trim() !== '' && s.status !== 'pending';
            return hasStatus;
          })
          .sort((a, b) => new Date(b.uploaded_at) - new Date(a.uploaded_at))
          .slice(0, 5);
        
        if (notificationItems.length === 0) {
          notificationsContainer.innerHTML = '<div class="notif">No new notifications <span class="notif-timestamp">--</span></div>';
          return;
        }
        
        let html = '';
        notificationItems.forEach(item => {
          // Use status_changed_at if available, otherwise fall back to uploaded_at
          const statusTimestamp = item.status_changed_at || item.uploaded_at;
          let timeAgo = '';
          let exactTime = '';
          
          if (item.status_changed_at) {
            // If we have exact timestamp from status change, use it directly
            exactTime = item.status_changed_at;
            // Parse the formatted timestamp to calculate time ago
            const statusChangeDate = new Date(item.status_changed_at);
            timeAgo = getTimeAgo(statusChangeDate);
          } else {
            // Fall back to uploaded_at
            const statusChangeDate = new Date(item.uploaded_at);
            timeAgo = getTimeAgo(statusChangeDate);
            exactTime = formatExactDateTime(statusChangeDate);
          }
          
          // Get document title - use title if available, otherwise use filename
          const documentTitle = item.title && item.title.trim() !== '' 
            ? item.title 
            : (item.original_name || item.filename || 'Untitled Document');
          
          let statusMessage = '';
          let statusIcon = '';
          let borderColor = '#0066cc';
          const hasComments = item.remarks && item.remarks.trim() !== '';
          
          // Check status - handle all possible variations
          const status = (item.status || '').trim();
          
          if (status === 'approved') {
            statusIcon = '‚úÖ';
            statusMessage = `Approved: ${documentTitle}`;
            borderColor = '#28a745';
          } else if (status === 'under review') {
            statusIcon = 'üîç';
            statusMessage = `Under Review: ${documentTitle}`;
            borderColor = '#ffc107';
          } else if (status === 'review') {
            statusIcon = 'üîç';
            statusMessage = `Under Review: ${documentTitle}`;
            borderColor = '#ffc107';
          } else if (status === 'rejected') {
            statusIcon = '‚ùå';
            statusMessage = `Rejected: ${documentTitle}`;
            borderColor = '#dc3545';
          } else if (status === 'pending') {
            statusIcon = '‚è≥';
            statusMessage = `Pending: ${documentTitle}`;
            borderColor = '#6c757d';
          } else if (status === '') {
            // Skip empty status items - should be filtered out already
            return;
          } else {
            // Fallback for any other status
            statusIcon = 'üìÑ';
            statusMessage = `Status "${status}": ${documentTitle}`;
            borderColor = '#6c757d';
          }
          
          // Mark this notification as viewed when displayed
          markSubmissionAsViewed(item.id, status);
          
          html += `
            <div class="notif" style="border-left-color: ${borderColor};">
              <strong style="font-size: 1.05em; color: #000; display: block; margin-bottom: 10px;">
                ${statusIcon} ${statusMessage}
              </strong>
              ${hasComments ? `<div style="padding: 8px; background: #fffbea; border-left: 3px solid #ffc107; margin-bottom: 10px; font-size: 0.9em; color: #333;">üí¨ <strong>Remarks:</strong> ${item.remarks.substring(0, 100)}${item.remarks.length > 100 ? '...' : ''}</div>` : ''}
              <span class="notif-timestamp">üïí ${exactTime} (${timeAgo})</span>
            </div>
          `;
        });
        
        notificationsContainer.innerHTML = html;
        
        // Update badge count after marking notifications as viewed
        const unviewedCount = allSubmissions.filter(s => {
          const status = s.status ? s.status.toLowerCase().trim() : '';
          const hasStatusChange = status === 'approved' || status === 'rejected' || status === 'review';
          const notViewed = !isSubmissionViewed(s.id, status);
          return hasStatusChange && notViewed;
        }).length;
        updateSidebarBadge('submissionsNotifBadge', unviewedCount);
      }
      
      // Function to update Recent Activity
      function updateRecentActivity(total, pending, review) {
        const activityText = document.getElementById('recent-activity-text');
        
        if (!activityText) return;
        
        if (total === 0) {
          activityText.innerHTML = 'No submissions yet. Start by uploading your first report.';
          return;
        }
        
        let statusParts = [];
        if (pending > 0) statusParts.push(`${pending} pending`);
        if (review > 0) statusParts.push(`${review} under review`);
        
        if (statusParts.length > 0) {
          activityText.innerHTML = `You have ${statusParts.join(' and ')} out of ${total} total submission${total > 1 ? 's' : ''}.`;
        } else {
          activityText.innerHTML = `All ${total} submission${total > 1 ? 's are' : ' is'} processed. Great work!`;
        }
      }
      
      // Helper function to calculate time ago
      function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
        if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }
      
      // Helper function to format exact date and time
      function formatExactDateTime(date) {
        return date.toLocaleString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: true
        });
      }
      
      // Load submissions function
      async function loadSubmissions() {
        try {
          const response = await fetch('api/submissions.php');
          const result = await response.json();
          
          if (result.ok) {
            const tbody = document.getElementById('submissions-table-body');
            tbody.innerHTML = '';
            
            // Store all submissions globally
            allSubmissions = result.submissions || [];
            
            // Also load archived submissions
            try {
              const archivedResponse = await fetch('api/submissions.php?archived=1');
              const archivedResult = await archivedResponse.json();
              if (archivedResult.ok) {
                allArchivedSubmissions = archivedResult.submissions || [];
                // Update archived count badge
                const badge = document.getElementById('archived-count-badge');
                if (badge) {
                  badge.textContent = allArchivedSubmissions.length;
                }
              }
            } catch (e) {
              // Silently fail if archived loading fails
              allArchivedSubmissions = [];
            }
            
            if (allSubmissions.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No submissions yet</td></tr>';
              // Update sidebar badge
              updateSidebarBadge('submissionsNotifBadge', 0);
              return;
            }
            
            // Update dashboard stats
            const total = allSubmissions.length;
            const approved = allSubmissions.filter(s => s.status === 'approved').length;
            const review = allSubmissions.filter(s => s.status === 'review').length;
            const pending = allSubmissions.filter(s => s.status === 'pending').length;
            const rejected = allSubmissions.filter(s => s.status === 'rejected').length;
            
            document.getElementById('total-submissions').textContent = total;
            document.getElementById('approved-count').textContent = approved;
            document.getElementById('review-count').textContent = review;
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('rejected-count').textContent = rejected;
            
            // Update filter counts
            updateFilterCounts(total, pending, review, approved, rejected);
            
            // Update sidebar badge
            // Submissions badge shows only UNVIEWED items with status changes (approved, rejected, review - not pending)
            const itemsWithStatusChanges = allSubmissions.filter(s => {
              const status = s.status ? s.status.toLowerCase().trim() : '';
              const hasStatusChange = status === 'approved' || status === 'rejected' || status === 'review';
              const notViewed = !isSubmissionViewed(s.id, status);
              return hasStatusChange && notViewed;
            }).length;
            updateSidebarBadge('submissionsNotifBadge', itemsWithStatusChanges);
            
            // Update Recent Notifications
            updateRecentNotifications(allSubmissions);
            
            // Update Recent Activity
            updateRecentActivity(total, pending, review);
            
            // Reset view state and display
            showingAllSubmissions = false;
            const viewAllBtn = document.getElementById('view-all-button');
            if (viewAllBtn) {
              viewAllBtn.textContent = 'View All Submissions';
            }
            
            // Clear search input
            const searchInput = document.getElementById('submission-search');
            if (searchInput) {
              searchInput.value = '';
            }
            
            // Show recent 5 submissions using the display function
            displaySubmissions(allSubmissions.slice(0, 5));
          }
        } catch (error) {
          
          // Update Recent Activity with error state
          const activityText = document.getElementById('recent-activity-text');
          if (activityText) {
            activityText.innerHTML = 'Unable to load submissions. Please refresh the page or check your connection.';
            activityText.style.color = '#d32f2f';
          }
          
          // Update dashboard stats to show 0
          document.getElementById('total-submissions').textContent = '0';
          document.getElementById('approved-count').textContent = '0';
          document.getElementById('review-count').textContent = '0';
          document.getElementById('pending-count').textContent = '0';
          document.getElementById('rejected-count').textContent = '0';
        }
      }
      
      // Filter submissions by type (active/archived)
      window.filterSubmissionsByType = debounce(function(type) {
        currentTypeFilter = type;
        
        // Update active button for type filter
        document.querySelectorAll('.type-filter-btn').forEach(btn => {
          btn.classList.remove('active');
          btn.style.background = 'white';
          btn.style.color = '#666';
          btn.style.borderColor = '#666';
        });
        const activeBtn = document.getElementById('filter-' + type);
        if (activeBtn) {
          activeBtn.classList.add('active');
          activeBtn.style.background = '#0066cc';
          activeBtn.style.color = 'white';
          activeBtn.style.borderColor = '#0066cc';
        }
        
        if (type === 'active') {
          // Show status filters for active submissions
          document.getElementById('status-filters').style.display = 'flex';
          // Reset to current status filter
          filterSubmissionsByStatus(currentStatusFilter);
        } else {
          // Hide status filters for archived
          document.getElementById('status-filters').style.display = 'none';
          // Show archived submissions
          displaySubmissions(allArchivedSubmissions);
          // Update view all button
          const viewAllBtn = document.getElementById('view-all-button');
          if (viewAllBtn) {
            viewAllBtn.textContent = 'Show Recent Only';
          }
        }
      }, 200);
      
      // Archive submission function with debouncing
      window.archiveSubmission = debounce(async function(id, event) {
        // Prevent if already processing
        if (event && event.target) {
          const btn = event.target.closest('a');
          if (btn && isButtonBusy(btn)) {
            return;
          }
          if (btn) {
            setButtonBusy(btn, true);
          }
        }
        
        const proceed = await showCustomConfirm('Are you sure you want to archive this submission?', 'warning');
        if (!proceed) {
          if (event && event.target) {
            const btn = event.target.closest('a');
            if (btn) setButtonBusy(btn, false);
          }
          return;
        }
        
        try {
          const response = await fetch(`api/submissions.php?id=${id}&action=archive`, {
            method: 'DELETE'
          });
          
          const result = await response.json();
          
          if (result.ok) {
            showCustomAlert('Submission archived successfully', 'success');
            await loadSubmissions();
            // Refresh current view
            if (currentTypeFilter === 'archived') {
              filterSubmissionsByType('archived');
            } else {
              filterSubmissionsByStatus(currentStatusFilter);
            }
          } else {
            showCustomAlert('Error: ' + (result.error || 'Failed to archive submission'), 'error');
          }
        } catch (error) {
          showCustomAlert('Failed to archive submission', 'error');
        } finally {
          if (event && event.target) {
            const btn = event.target.closest('a');
            if (btn) setButtonBusy(btn, false);
          }
        }
      }, 500);

      // Restore submission function with debouncing
      window.restoreSubmission = debounce(async function(id, event) {
        if (event && event.target) {
          const btn = event.target.closest('a');
          if (btn && isButtonBusy(btn)) {
            return;
          }
          if (btn) setButtonBusy(btn, true);
        }
        
        const proceed = await showCustomConfirm('Are you sure you want to restore this submission?', 'info');
        if (!proceed) {
          if (event && event.target) {
            const btn = event.target.closest('a');
            if (btn) setButtonBusy(btn, false);
          }
          return;
        }
        
        try {
          const response = await fetch(`api/submissions.php?id=${id}&action=restore`, {
            method: 'DELETE'
          });
          
          const result = await response.json();
          
          if (result.ok) {
            showCustomAlert('Submission restored successfully', 'success');
            await loadSubmissions();
            // Refresh current view
            if (currentTypeFilter === 'archived') {
              filterSubmissionsByType('archived');
            }
          } else {
            showCustomAlert('Error: ' + (result.error || 'Failed to restore submission'), 'error');
          }
        } catch (error) {
          showCustomAlert('Failed to restore submission', 'error');
        } finally {
          if (event && event.target) {
            const btn = event.target.closest('a');
            if (btn) setButtonBusy(btn, false);
          }
        }
      }, 500);

      // Delete submission function (permanent delete) with debouncing
      window.deleteSubmission = debounce(async function(id, event) {
        if (event && event.target) {
          const btn = event.target.closest('a');
          if (btn && isButtonBusy(btn)) {
            return;
          }
          if (btn) setButtonBusy(btn, true);
        }
        
        const proceed = await showCustomConfirm('Are you sure you want to permanently delete this submission? This action cannot be undone.', 'error');
        if (!proceed) {
          if (event && event.target) {
            const btn = event.target.closest('a');
            if (btn) setButtonBusy(btn, false);
          }
          return;
        }
        
        try {
          const response = await fetch(`api/submissions.php?id=${id}`, {
            method: 'DELETE'
          });
          
          const result = await response.json();
          
          if (result.ok) {
            showCustomAlert('Submission deleted successfully', 'success');
            await loadSubmissions();
            // Refresh current view
            if (currentTypeFilter === 'archived') {
              filterSubmissionsByType('archived');
            }
          } else {
            showCustomAlert('Error: ' + (result.error || 'Failed to delete submission'), 'error');
          }
        } catch (error) {
          showCustomAlert('Failed to delete submission', 'error');
        } finally {
          if (event && event.target) {
            const btn = event.target.closest('a');
            if (btn) setButtonBusy(btn, false);
          }
        }
      }, 500);
      
      // Track viewed/seen submissions in localStorage
      function getViewedSubmissions() {
        try {
          const viewed = localStorage.getItem('viewedSubmissions');
          return viewed ? JSON.parse(viewed) : {};
        } catch {
          return {};
        }
      }
      
      function markSubmissionAsViewed(submissionId, status) {
        try {
          const viewed = getViewedSubmissions();
          viewed[submissionId] = { status, viewedAt: new Date().toISOString() };
          localStorage.setItem('viewedSubmissions', JSON.stringify(viewed));
        } catch (e) {
          // Silently fail if localStorage is not available
        }
      }
      
      function isSubmissionViewed(submissionId, currentStatus) {
        const viewed = getViewedSubmissions();
        // Consider viewed if submission ID is in viewed list and status hasn't changed
        return viewed[submissionId] && viewed[submissionId].status === currentStatus;
      }
      
      // Update filter counts function
      function updateFilterCounts(total, pending, review, approved, rejected) {
        document.getElementById('count-all').textContent = total;
        document.getElementById('count-pending-filter').textContent = pending;
        document.getElementById('count-review-filter').textContent = review;
        document.getElementById('count-approved-filter').textContent = approved;
        document.getElementById('count-rejected-filter').textContent = rejected;
      }

      // Filter submissions by status with debouncing
      window.filterSubmissionsByStatus = debounce(function(status) {
        currentStatusFilter = status;
        
        // Update active button
        document.querySelectorAll('#status-filters .status-filter-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.getElementById('filter-' + status).classList.add('active');
        
        // Filter active submissions only
        let filteredSubmissions = allSubmissions;
        if (status !== 'all') {
          filteredSubmissions = allSubmissions.filter(submission => submission.status === status);
        }
        
        // Apply search if there's a search term
        const searchTerm = document.getElementById('submission-search').value.toLowerCase().trim();
        if (searchTerm !== '') {
          filteredSubmissions = filteredSubmissions.filter(submission => {
            const title = submission.title.toLowerCase();
            const category = submission.category.toLowerCase();
            const status = submission.status.toLowerCase();
            const date = new Date(submission.created_at).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            }).toLowerCase();
            
            return title.includes(searchTerm) || 
                   category.includes(searchTerm) || 
                   status.includes(searchTerm) ||
                   date.includes(searchTerm);
          });
        }
        
        displaySubmissions(filteredSubmissions);
        
        // Update view all button
        const viewAllBtn = document.getElementById('view-all-button');
        if (viewAllBtn) {
          showingAllSubmissions = true;
          viewAllBtn.textContent = 'Show Recent Only';
        }
      }, 200);

      // Function to display submissions in the table
      function displaySubmissions(submissions) {
        const tbody = document.getElementById('submissions-table-body');
        tbody.innerHTML = '';
        
        if (submissions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No submissions found</td></tr>';
          return;
        }
        
        submissions.forEach(submission => {
          const row = document.createElement('tr');
          
          const statusClass = {
            'pending': 'status-pending',
            'review': 'status-review',
            'approved': 'status-approved',
            'rejected': 'status-rejected'
          }[submission.status] || 'status-pending';
          
          const statusText = {
            'pending': 'Pending',
            'review': 'Under Review',
            'approved': 'Approved',
            'rejected': 'Rejected'
          }[submission.status] || submission.status;
          
          const date = new Date(submission.created_at).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
          
          // Format status change timestamp if available
          let statusChangedTime = '';
          if (submission.status_changed_at) {
            statusChangedTime = `<br><small style="color: #007bff; font-weight: bold; font-size: 0.75em;">üïí ${submission.status_changed_at}</small>`;
          }
          
          // Check if there are comments/remarks from ABC
          const hasComments = submission.remarks && submission.remarks.trim() !== '';
          const commentIndicator = hasComments ? ' üí¨' : '';
          let commentPreview = '';
          
          if (hasComments) {
            // Get latest comment for preview
            const entries = submission.remarks.split('\n\n').filter(entry => entry.trim() !== '');
            if (entries.length > 0) {
              const lastEntry = entries[entries.length - 1];
              const match = lastEntry.match(/^\[([^\]]+)\]\s*(.*)$/s);
              if (match) {
                const commentText = match[2].substring(0, 60) + (match[2].length > 60 ? '...' : '');
                commentPreview = `<div class="comment-preview">ABC Comment: "${commentText}"</div>`;
              } else {
                const commentText = lastEntry.substring(0, 60) + (lastEntry.length > 60 ? '...' : '');
                commentPreview = `<div class="comment-preview">ABC Comment: "${commentText}"</div>`;
              }
            }
          }
          
          // Only show archive button if status is still pending (not yet processed by ABC)
          // But if we're viewing archived submissions, show restore and delete instead
          let actionButtons = '';
          
          if (currentTypeFilter === 'archived') {
            // For archived submissions, show Restore and Delete
            actionButtons = `
              <a href="#" onclick="restoreSubmission(${submission.id}); return false;" 
                 style="color: #28a745; text-decoration: none; margin-left: 8px;" title="Restore submission">‚Ü©Ô∏èRestore</a>
              <a href="#" onclick="deleteSubmission(${submission.id}); return false;" 
                 style="color: #dc3545; text-decoration: none; margin-left: 8px;" title="Permanently delete">üóëÔ∏èDelete</a>
            `;
          } else {
            // For active submissions, show archive button only if pending
            actionButtons = submission.status === 'pending' 
              ? `<a href="#" onclick="archiveSubmission(${submission.id}); return false;" 
                   style="color: #ff9800; text-decoration: none; margin-left: 8px;" title="Archive submission">üì¶Archive</a>`
              : `<span style="color: #999; margin-left: 8px;" title="Documents processed by ABC cannot be archived">üîíArchive</span>`;
          }
          
          row.innerHTML = `
            <td>
              ${submission.title}${commentIndicator}
              ${commentPreview}
            </td>
            <td>${submission.category}</td>
            <td>${date}</td>
            <td>
              <span class="status-badge ${statusClass}">${statusText}</span>${statusChangedTime}
            </td>
            <td>
              <a href="view_submission.html?id=${submission.id}" style="color: #0066cc; text-decoration: none; margin-right: 8px;" title="View form data">üìãView</a>
              <a href="javascript:void(0)" onclick="showDocumentViewer('${submission.filename}', '${submission.title}', ${submission.id})" style="color: #28a745; text-decoration: none; margin-right: 8px;" title="View PDF">üìÑPDF</a>
              ${hasComments ? `<a href="#" onclick="viewComments(${submission.id}, '${submission.title.replace(/'/g, "\\'")}'); return false;" 
                 class="comment-button" title="View ABC comments">üí¨View Comments</a>` : ''}
              ${actionButtons}
            </td>
          `;
          
          tbody.appendChild(row);
        });
      }
      
      // Search functionality
      const searchInput = document.getElementById('submission-search');
      const clearSearchButton = document.getElementById('clear-search-button');
      const viewAllButton = document.getElementById('view-all-button');
      
      if (searchInput) {
        const debouncedSearch = debounce(function() {
          const searchTerm = searchInput.value.toLowerCase().trim();
          
          // Start with current status filter
          let filteredSubmissions = allSubmissions;
          if (currentStatusFilter !== 'all') {
            filteredSubmissions = allSubmissions.filter(submission => submission.status === currentStatusFilter);
          }
          
          if (searchTerm === '') {
            // If search is empty, show filtered results
            if (showingAllSubmissions) {
              displaySubmissions(filteredSubmissions);
            } else {
              displaySubmissions(filteredSubmissions.slice(0, 5));
            }
            return;
          }
          
          // Apply search term to filtered submissions
          const searchFiltered = filteredSubmissions.filter(submission => {
            const title = submission.title.toLowerCase();
            const category = submission.category.toLowerCase();
            const status = submission.status.toLowerCase();
            const date = new Date(submission.created_at).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            }).toLowerCase();
            
            return title.includes(searchTerm) || 
                   category.includes(searchTerm) || 
                   status.includes(searchTerm) ||
                   date.includes(searchTerm);
          });
          
          displaySubmissions(searchFiltered);
        }, 300);
        
        searchInput.addEventListener('input', debouncedSearch);
      }
      
      // Clear search button
      if (clearSearchButton) {
        clearSearchButton.addEventListener('click', function() {
          searchInput.value = '';
          // Trigger filter with current status
          filterSubmissionsByStatus(currentStatusFilter);
        });
      }
      
      // View All Submissions button
      if (viewAllButton) {
        viewAllButton.addEventListener('click', function() {
          if (showingAllSubmissions) {
            // Toggle back to showing only recent 5
            showingAllSubmissions = false;
            this.textContent = 'View All Submissions';
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (searchTerm === '') {
              displaySubmissions(allSubmissions.slice(0, 5));
            } else {
              // Keep filtered results but only show first 5
              const filtered = allSubmissions.filter(submission => {
                const title = submission.title.toLowerCase();
                const category = submission.category.toLowerCase();
                const status = submission.status.toLowerCase();
                const date = new Date(submission.created_at).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric'
                }).toLowerCase();
                
                return title.includes(searchTerm) || 
                       category.includes(searchTerm) || 
                       status.includes(searchTerm) ||
                       date.includes(searchTerm);
              });
              displaySubmissions(filtered.slice(0, 5));
            }
          } else {
            // Show all submissions
            showingAllSubmissions = true;
            this.textContent = 'Show Recent Only';
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (searchTerm === '') {
              displaySubmissions(allSubmissions);
            } else {
              // Trigger search with current term
              searchInput.dispatchEvent(new Event('input'));
            }
          }
        });
      }
      
      // Load submissions on page load
      await loadSubmissions();
      await loadAnnouncements();
      
      // Check if there's a hash in the URL to navigate to a specific section
      const hash = window.location.hash.substring(1); // Remove the # symbol
      if (hash && (hash === 'submissions' || hash === 'dashboard' || hash === 'upload-document' || hash === 'announcements')) {
        showContent(hash);
      } else {
        showContent('dashboard');
      }
    })();
    });

    // ===== ANNOUNCEMENTS SECTION =====
    
    // Store announcements globally
    let allAnnouncements = [];
    
    async function loadAnnouncements() {
      try {
        const response = await fetch('api/announcements.php');
        
        const result = await response.json();
        
        const container = document.getElementById('announcements-list');
        
        if (!result.ok) {
          container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 20px;">Error: ' + (result.error || 'Failed to load') + '</p>';
          updateSidebarBadge('announcementsNotifBadge', 0);
          updateNotificationBadge(0);
          return;
        }
        
        if (!result.announcements || result.announcements.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No announcements at this time.</p>';
          updateSidebarBadge('announcementsNotifBadge', 0);
          updateNotificationBadge(0);
          allAnnouncements = [];
          return;
        }
        
        // Store announcements globally
        allAnnouncements = result.announcements;
        
        // Count unread announcements
        const unreadCount = result.announcements.filter(ann => !ann.is_read).length;
        updateSidebarBadge('announcementsNotifBadge', unreadCount);
        updateNotificationBadge(unreadCount);
        
        const announcementsHtml = result.announcements.map(ann => {
          const date = new Date(ann.created_at);
          const dateStr = date.toLocaleString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          const isUnread = !ann.is_read;
          const isHidden = hiddenAnnouncements.has(ann.id);
          
          return `
            <div class="announcement-card" data-announcement-id="${ann.id}" style="background: ${isUnread ? '#fff9e6' : 'white'}; border-left: 4px solid ${isUnread ? '#ffc107' : '#ddd'}; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: ${isHidden ? 'none' : 'block'};">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                <div style="flex: 1;">
                  ${isUnread ? '<span style="background: #ffc107; color: #000; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-bottom: 5px; display: inline-block;">NEW</span>' : ''}
                  <h4 style="margin: ${isUnread ? '5px 0 0 0' : '0'}; color: #004c99;">${ann.title}</h4>
                </div>
                <div style="display: flex; gap: 8px;">
                  <button onclick="toggleAnnouncementContent(${ann.id})" class="announcement-toggle-btn" style="background: none; border: 1px solid #ccc; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; color: #666; margin: 0;" title="Collapse/Expand">
                    <span id="toggle-text-${ann.id}">‚ñº</span>
                  </button>
                  <button onclick="hideAnnouncement(${ann.id})" style="background: none; border: 1px solid #dc3545; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; color: #dc3545; margin: 0;" title="Hide this announcement">
                    Hide
                  </button>
                </div>
              </div>
              <div id="announcement-content-${ann.id}" class="announcement-content" style="display: block;">
                <p style="margin: 10px 0; color: #333; line-height: 1.6; white-space: pre-wrap;">${ann.content}</p>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee;">
                  <span style="color: #666; font-size: 0.9em;">
                    <strong>From:</strong> ABC Portal
                  </span>
                  <span style="color: #999; font-size: 0.85em;">${dateStr}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        container.innerHTML = announcementsHtml;
        
        // Update dashboard notifications
        updateDashboardNotifications();
        
        // Update hidden announcements button
        updateHiddenAnnouncementsButton();
        
      } catch (error) {
        document.getElementById('announcements-list').innerHTML = '<p style="text-align: center; color: #dc3545; padding: 20px;">Error loading announcements.</p>';
        updateSidebarBadge('announcementsNotifBadge', 0);
        updateNotificationBadge(0);
      }
    }
    
    // Store hidden announcements in a Set
    let hiddenAnnouncements = new Set();
    
    // Toggle announcement content (collapse/expand)
    function toggleAnnouncementContent(announcementId) {
      const content = document.getElementById(`announcement-content-${announcementId}`);
      const toggleText = document.getElementById(`toggle-text-${announcementId}`);
      
      if (content && toggleText) {
        if (content.style.display === 'none') {
          content.style.display = 'block';
          toggleText.textContent = '‚ñº';
        } else {
          content.style.display = 'none';
          toggleText.textContent = '‚ñ∂';
        }
      }
    }
    
    // Hide announcement
    function hideAnnouncement(announcementId) {
      const card = document.querySelector(`.announcement-card[data-announcement-id="${announcementId}"]`);
      
      if (card) {
        // Add to hidden set
        hiddenAnnouncements.add(announcementId);
        
        // Animate hide
        card.style.transition = 'opacity 0.3s, transform 0.3s';
        card.style.opacity = '0';
        card.style.transform = 'translateX(-20px)';
        
        setTimeout(() => {
          card.style.display = 'none';
          updateHiddenAnnouncementsButton();
        }, 300);
      }
    }
    
    // Show hidden announcement
    function showAnnouncement(announcementId) {
      const card = document.querySelector(`.announcement-card[data-announcement-id="${announcementId}"]`);
      
      if (card) {
        // Remove from hidden set
        hiddenAnnouncements.delete(announcementId);
        
        // Show with animation
        card.style.display = 'block';
        card.style.opacity = '0';
        card.style.transform = 'translateX(-20px)';
        
        setTimeout(() => {
          card.style.transition = 'opacity 0.3s, transform 0.3s';
          card.style.opacity = '1';
          card.style.transform = 'translateX(0)';
          updateHiddenAnnouncementsButton();
        }, 10);
      }
    }
    
    // Update hidden announcements button
    function updateHiddenAnnouncementsButton() {
      const btn = document.getElementById('show-hidden-announcements-btn');
      const countSpan = document.getElementById('hidden-count');
      
      if (btn && countSpan) {
        const hiddenCount = hiddenAnnouncements.size;
        countSpan.textContent = hiddenCount;
        
        if (hiddenCount > 0) {
          btn.style.display = 'block';
        } else {
          btn.style.display = 'none';
        }
      }
    }
    
    // Toggle showing hidden announcements
    function toggleHiddenAnnouncements() {
      const hiddenArray = Array.from(hiddenAnnouncements);
      
      if (hiddenArray.length > 0) {
        // Show all hidden announcements
        hiddenArray.forEach(id => showAnnouncement(id));
        hiddenAnnouncements.clear();
        updateHiddenAnnouncementsButton();
      }
    }
    
    // Update notification badge in header
    function updateNotificationBadge(count) {
      const badge = document.getElementById('notificationBadge');
      if (badge) {
        badge.textContent = count;
        if (count > 0) {
          badge.classList.add('show');
        } else {
          badge.classList.remove('show');
        }
      }
    }
    
    // Toggle notification dropdown
    function toggleNotificationDropdown() {
      const dropdown = document.getElementById('notificationDropdown');
      if (dropdown) {
        const isShowing = dropdown.classList.contains('show');
        if (isShowing) {
          dropdown.classList.remove('show');
        } else {
          dropdown.classList.add('show');
          renderNotificationDropdown();
        }
      }
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('notificationDropdown');
      const bell = document.getElementById('notificationBell');
      
      if (dropdown && bell && !dropdown.contains(event.target) && !bell.contains(event.target)) {
        dropdown.classList.remove('show');
      }
    });
    
    // Render notification dropdown content
    function renderNotificationDropdown() {
      const dropdownBody = document.getElementById('notificationDropdownBody');
      if (!dropdownBody) return;
      
      if (allAnnouncements.length === 0) {
        dropdownBody.innerHTML = `
          <div class="notification-empty">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
            </svg>
            <p>No new notifications</p>
          </div>
        `;
        return;
      }
      
      // Show only recent 5 announcements
      const recentAnnouncements = allAnnouncements.slice(0, 5);
      
      const notificationsHtml = recentAnnouncements.map(ann => {
        const date = new Date(ann.created_at);
        const timeAgo = getTimeAgo(date);
        const isUnread = !ann.is_read;
        
        // Truncate content for preview
        const contentPreview = ann.content.length > 80 
          ? ann.content.substring(0, 80) + '...' 
          : ann.content;
        
        return `
          <div class="notification-item ${isUnread ? 'unread' : ''}" data-announcement-id="${ann.id}">
            <div class="notification-item-header">
              <div class="notification-item-title">${ann.title}</div>
              <div class="notification-item-actions">
                ${isUnread ? `<button class="notification-item-action" onclick="markAnnouncementAsRead(${ann.id}, event)" title="Mark as read">‚úì</button>` : ''}
                <button class="notification-item-action" onclick="deleteNotification(${ann.id}, event)" title="Remove">‚úï</button>
              </div>
            </div>
            <div class="notification-item-content">${contentPreview}</div>
            <div class="notification-item-time">${timeAgo}</div>
          </div>
        `;
      }).join('');
      
      dropdownBody.innerHTML = notificationsHtml;
    }
    
    // Get relative time (e.g., "2 hours ago")
    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
      
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    // Mark single announcement as read
    async function markAnnouncementAsRead(announcementId, event) {
      if (event) {
        event.stopPropagation();
      }
      
      try {
        const response = await fetch('api/announcements.php', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            announcement_id: announcementId
          })
        });
        
        const result = await response.json();
        
        if (result.ok) {
          // Update local state
          const announcement = allAnnouncements.find(a => a.id === announcementId);
          if (announcement) {
            announcement.is_read = 1;
          }
          
          // Update UI
          const unreadCount = allAnnouncements.filter(ann => !ann.is_read).length;
          updateSidebarBadge('announcementsNotifBadge', unreadCount);
          updateNotificationBadge(unreadCount);
          
          // Refresh dropdown
          renderNotificationDropdown();
          
          // Refresh announcements page if currently viewing
          await loadAnnouncements();
        }
      } catch (error) {
        console.error('Error marking announcement as read:', error);
      }
    }
    
    // Mark all announcements as read
    async function markAllAnnouncementsAsRead() {
      const unreadAnnouncements = allAnnouncements.filter(ann => !ann.is_read);
      
      if (unreadAnnouncements.length === 0) {
        return;
      }
      
      try {
        // Mark all unread announcements as read
        const promises = unreadAnnouncements.map(ann => 
          fetch('api/announcements.php', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              announcement_id: ann.id
            })
          })
        );
        
        await Promise.all(promises);
        
        // Update local state
        allAnnouncements.forEach(ann => {
          ann.is_read = 1;
        });
        
        // Update UI
        updateSidebarBadge('announcementsNotifBadge', 0);
        updateNotificationBadge(0);
        
        // Refresh dropdown
        renderNotificationDropdown();
        
        // Refresh announcements page if currently viewing
        await loadAnnouncements();
        
      } catch (error) {
        console.error('Error marking all announcements as read:', error);
      }
    }
    
    // Delete/remove notification (local only - just hides from dropdown)
    function deleteNotification(announcementId, event) {
      if (event) {
        event.stopPropagation();
      }
      
      // Mark as read first
      markAnnouncementAsRead(announcementId, null);
      
      // Remove from dropdown immediately
      const notificationItem = document.querySelector(`.notification-item[data-announcement-id="${announcementId}"]`);
      if (notificationItem) {
        notificationItem.style.transition = 'opacity 0.3s, transform 0.3s';
        notificationItem.style.opacity = '0';
        notificationItem.style.transform = 'translateX(100%)';
        
        setTimeout(() => {
          notificationItem.remove();
          
          // Check if dropdown is now empty
          const remainingItems = document.querySelectorAll('.notification-item');
          if (remainingItems.length === 0) {
            renderNotificationDropdown();
          }
        }, 300);
      }
    }
    
    // Update dashboard notifications section
    function updateDashboardNotifications() {
      const notificationsContainer = document.getElementById('notifications-container');
      if (!notificationsContainer) return;
      
      const unreadAnnouncements = allAnnouncements.filter(ann => !ann.is_read).slice(0, 3);
      
      if (unreadAnnouncements.length === 0) {
        notificationsContainer.innerHTML = '<div class="notif">No new notifications <span class="notif-timestamp">--</span></div>';
        return;
      }
      
      const notificationsHtml = unreadAnnouncements.map(ann => {
        const date = new Date(ann.created_at);
        const timeAgo = getTimeAgo(date);
        
        return `
          <div class="notif">
            <strong>${ann.title}</strong> - ${ann.content.substring(0, 60)}${ann.content.length > 60 ? '...' : ''}
            <span class="notif-timestamp">${timeAgo}</span>
          </div>
        `;
      }).join('');
      
      notificationsContainer.innerHTML = notificationsHtml;
    }

    // ===== ARCHIVED SUBMISSIONS SECTION =====
    
    // Store all archived submissions globally for search/filter
    let allArchivedSubmissions = [];
    let showingAllArchived = false;
    
    // Function to load archived submissions from the API
    async function loadArchivedSubmissions() {
      try {
        const response = await fetch('api/submissions.php?archived=1');
        const result = await response.json();
        
        if (result.ok) {
          allArchivedSubmissions = result.submissions || [];
          
          // Reset view state and display
          showingAllArchived = false;
          const viewAllArchivedBtn = document.getElementById('view-all-archived-button');
          if (viewAllArchivedBtn) {
            viewAllArchivedBtn.textContent = 'View All Archived';
          }
          
          // Clear search input
          const archivedSearchInput = document.getElementById('archived-search');
          if (archivedSearchInput) {
            archivedSearchInput.value = '';
          }
          
          // Show recent 5 archived submissions
          displayArchivedSubmissions(allArchivedSubmissions.slice(0, 5));
        }
      } catch (error) {
      }
    }
    
    // Function to display archived submissions in the table
    function displayArchivedSubmissions(submissions) {
      const tbody = document.getElementById('archived-table-body');
      tbody.innerHTML = '';
      
      if (submissions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No archived submissions found</td></tr>';
        return;
      }
      
      submissions.forEach(submission => {
        const row = document.createElement('tr');
        
        const statusClass = {
          'pending': 'status-pending',
          'review': 'status-review',
          'approved': 'status-approved',
          'rejected': 'status-rejected'
        }[submission.status] || 'status-pending';
        
        const statusText = {
          'pending': 'Pending',
          'review': 'Under Review',
          'approved': 'Approved',
          'rejected': 'Rejected'
        }[submission.status] || submission.status;
        
        const date = new Date(submission.created_at).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
        
        // Format status change timestamp if available
        let statusChangedTime = '';
        if (submission.status_changed_at) {
          statusChangedTime = `<br><small style="color: #007bff; font-weight: bold; font-size: 0.75em;">üïí ${submission.status_changed_at}</small>`;
        }
        
        // Check if there are comments/remarks from ABC
        const hasComments = submission.remarks && submission.remarks.trim() !== '';
        const commentIndicator = hasComments ? ' üí¨' : '';
        let commentPreview = '';
        
        if (hasComments) {
          // Get latest comment for preview
          const entries = submission.remarks.split('\n\n').filter(entry => entry.trim() !== '');
          if (entries.length > 0) {
            const lastEntry = entries[entries.length - 1];
            const match = lastEntry.match(/^\[([^\]]+)\]\s*(.*)$/s);
            if (match) {
              const commentText = match[2].substring(0, 60) + (match[2].length > 60 ? '...' : '');
              commentPreview = `<div class="comment-preview">ABC Comment: "${commentText}"</div>`;
            } else {
              const commentText = lastEntry.substring(0, 60) + (lastEntry.length > 60 ? '...' : '');
              commentPreview = `<div class="comment-preview">ABC Comment: "${commentText}"</div>`;
            }
          }
        }
        
        // Only show restore/delete buttons if status is still pending (not yet processed by ABC)
        const actionButtons = submission.status === 'pending' 
          ? `| <a href="#" onclick="restoreSubmission(${submission.id}); return false;" style="color: #28a745; text-decoration: none;">Restore</a>
            | <a href="#" onclick="deleteSubmission(${submission.id}); return false;" style="color: #dc3545; text-decoration: none;">Delete</a>`
          : `| <span style="color: #999;" title="Documents processed by ABC cannot be modified">üîíLocked (Processed by ABC)</span>`;
        
        row.innerHTML = `
          <td>
            ${submission.title}${commentIndicator}
            ${commentPreview}
          </td>
          <td>${submission.category}</td>
          <td>${date}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span>${statusChangedTime}</td>
          <td>
            <a href="view_submission.html?id=${submission.id}" style="color: #0066cc; text-decoration: none; margin-right: 8px;" title="View form data">üìãView</a>
            <a href="javascript:void(0)" onclick="showDocumentViewer('${submission.filename}', '${submission.title}', ${submission.id})" style="color: #28a745; text-decoration: none;" title="View PDF">üìÑPDF</a>
            ${hasComments ? ` | <a href="#" onclick="viewComments(${submission.id}, '${submission.title.replace(/'/g, "\\'")}'); return false;" 
               style="color: #17a2b8; text-decoration: none;">üí¨Comments</a>` : ''}
            ${actionButtons}
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }
    
    // Search functionality for archived
    const archivedSearchInput = document.getElementById('archived-search');
    const clearArchivedSearchButton = document.getElementById('clear-archived-search-button');
    const viewAllArchivedButton = document.getElementById('view-all-archived-button');
    
    if (archivedSearchInput) {
      archivedSearchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        
        if (searchTerm === '') {
          // If search is empty, show recent 5 or all depending on state
          if (showingAllArchived) {
            displayArchivedSubmissions(allArchivedSubmissions);
          } else {
            displayArchivedSubmissions(allArchivedSubmissions.slice(0, 5));
          }
          return;
        }
        
        // Filter archived submissions based on search term
        const filtered = allArchivedSubmissions.filter(submission => {
          const title = submission.title.toLowerCase();
          const category = submission.category.toLowerCase();
          const status = submission.status.toLowerCase();
          const date = new Date(submission.created_at).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          }).toLowerCase();
          
          return title.includes(searchTerm) || 
                 category.includes(searchTerm) || 
                 status.includes(searchTerm) ||
                 date.includes(searchTerm);
        });
        
        displayArchivedSubmissions(filtered);
      });
    }
    
    // Clear search button for archived
    if (clearArchivedSearchButton) {
      clearArchivedSearchButton.addEventListener('click', function() {
        if (archivedSearchInput) {
          archivedSearchInput.value = '';
          if (showingAllArchived) {
            displayArchivedSubmissions(allArchivedSubmissions);
          } else {
            displayArchivedSubmissions(allArchivedSubmissions.slice(0, 5));
          }
        }
      });
    }
    
    // View All Archived button
    if (viewAllArchivedButton) {
      viewAllArchivedButton.addEventListener('click', function() {
        if (showingAllArchived) {
          // Toggle back to showing only recent 5
          showingAllArchived = false;
          this.textContent = 'View All Archived';
          const searchTerm = archivedSearchInput.value.toLowerCase().trim();
          if (searchTerm === '') {
            displayArchivedSubmissions(allArchivedSubmissions.slice(0, 5));
          } else {
            // Keep filtered results but only show first 5
            const filtered = allArchivedSubmissions.filter(submission => {
              const title = submission.title.toLowerCase();
              const category = submission.category.toLowerCase();
              const status = submission.status.toLowerCase();
              const date = new Date(submission.created_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
              }).toLowerCase();
              
              return title.includes(searchTerm) || 
                     category.includes(searchTerm) || 
                     status.includes(searchTerm) ||
                     date.includes(searchTerm);
            });
            displayArchivedSubmissions(filtered.slice(0, 5));
          }
        } else {
          // Show all archived submissions
          showingAllArchived = true;
          this.textContent = 'Show Recent Only';
          const searchTerm = archivedSearchInput.value.toLowerCase().trim();
          if (searchTerm === '') {
            displayArchivedSubmissions(allArchivedSubmissions);
          } else {
            // Trigger search with current term
            archivedSearchInput.dispatchEvent(new Event('input'));
          }
        }
      });
    }

    // Function to view ABC comments for a submission
    async function viewComments(submissionId, title) {
      try {
        // Get submission details with comments
        const response = await fetch(`api/submissions.php?id=${submissionId}`);
        const result = await response.json();
        
        if (!result.ok) {
          showCustomAlert('Error loading comments: ' + (result.error || 'Unknown error'), 'error');
          return;
        }
        
        const submission = result.submission || {};
        const remarks = submission.remarks || '';
        
        // Create modal HTML
        const modalHtml = `
          <div class="comment-modal" onclick="this.remove()">
            <div class="comment-modal-content" onclick="event.stopPropagation()">
              <h2 style="margin-top: 0; color: #004c99;">üí¨ ABC Comments</h2>
              
              <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                <strong>Document:</strong> ${title}<br>
                <strong>Status:</strong> <span class="status-badge status-${submission.status || 'pending'}">${submission.status || 'Pending'}</span>${submission.status_changed_at ? `<br><small style="color: #007bff; font-weight: bold;">üïí Status changed: ${submission.status_changed_at}</small>` : ''}<br>
                <strong>Last Updated:</strong> ${submission.reviewed_at ? new Date(submission.reviewed_at).toLocaleString() : 'Not yet reviewed'}
              </div>
              
              <div style="margin-bottom: 20px;">
                <h3 style="color: #495057; font-size: 1.1em; margin-bottom: 10px;">üìù Comments from ABC:</h3>
                <div style="max-height: 400px; overflow-y: auto;">
                  ${formatCommentsForBarangay(remarks)}
                </div>
              </div>
              
              <div style="text-align: right;">
                <button onclick="this.closest('.comment-modal').remove()" 
                        style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                  Close
                </button>
              </div>
            </div>
          </div>
        `;
        
        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
      } catch (error) {
        showCustomAlert('Error loading comments: ' + error.message, 'error');
      }
    }
    
    // Format comments for display in barangay portal
    function formatCommentsForBarangay(remarksText) {
      if (!remarksText || remarksText.trim() === '') {
        return '<p style="color: #6c757d; font-style: italic; text-align: center;">No comments from ABC yet.</p>';
      }
      
      // Split by double newlines to separate different comment entries
      const entries = remarksText.split('\n\n').filter(entry => entry.trim() !== '');
      
      if (entries.length === 0) {
        return '<p style="color: #6c757d; font-style: italic; text-align: center;">No comments from ABC yet.</p>';
      }
      
      let formattedHtml = '';
      entries.forEach((entry, index) => {
        // Check if entry has timestamp format [datetime]
        const timestampMatch = entry.match(/^\[([^\]]+)\]\s*(.*)$/s);
        
        if (timestampMatch) {
          const timestamp = timestampMatch[1];
          const content = timestampMatch[2].trim();
          
          formattedHtml += `
            <div class="comment-entry">
              <div class="comment-timestamp">
                üïí ${timestamp}
              </div>
              <div class="comment-text">
                ${content.replace(/\n/g, '<br>')}
              </div>
            </div>
          `;
        } else {
          // Entry without timestamp - legacy format
          formattedHtml += `
            <div class="comment-entry">
              <div class="comment-text">
                ${entry.replace(/\n/g, '<br>')}
              </div>
            </div>
          `;
        }
      });
      
      return formattedHtml;
    }
    
    // Function to show document viewer modal
    function showDocumentViewer(filename, title, submissionId = null) {
        const modal = document.createElement('div');
        modal.className = 'doc-viewer-modal';
        modal.onclick = function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        };
        
        // Get file extension to determine how to display
        const extension = filename.split('.').pop().toLowerCase();
        // Use absolute path from root to ensure it works when hosted
        const baseUrl = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '/');
        
        // Use generate_pdf.php if submission has form_data, otherwise use view_file.php
        let fileUrl, downloadUrl;
        if (submissionId && extension === 'pdf') {
            fileUrl = `${baseUrl}api/generate_pdf.php?id=${submissionId}`;
            downloadUrl = `${baseUrl}api/view_file.php?file=${encodeURIComponent(filename)}&download=1`;
        } else {
            fileUrl = `${baseUrl}api/view_file.php?file=${encodeURIComponent(filename)}`;
            downloadUrl = `${baseUrl}api/view_file.php?file=${encodeURIComponent(filename)}&download=1`;
        }
        
        // Create proper download filename with extension
        const downloadFilename = title && !title.includes('.') ? `${title}.${extension}` : (title || filename);
        
        modal.innerHTML = `
            <div class="doc-viewer-container" onclick="event.stopPropagation()">
                <div class="doc-viewer-header">
                    <div class="doc-viewer-title">
                        üìÑ ${title || filename}
                    </div>
                    <div class="doc-viewer-actions">
                        <button class="doc-viewer-btn doc-viewer-download" onclick="printPDF()">
                            ‚¨áÔ∏è Download/Print PDF
                        </button>
                        <button class="doc-viewer-btn doc-viewer-close" onclick="this.closest('.doc-viewer-modal').remove()">
                            ‚úñ Close
                        </button>
                    </div>
                </div>
                <div class="doc-viewer-content">
                    <div class="doc-viewer-loading">
                        <div class="doc-viewer-spinner"></div>
                        <p>Loading document...</p>
                    </div>
                    <iframe class="doc-viewer-iframe" src="" style="display: none;"></iframe>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Load the document
        const iframe = modal.querySelector('.doc-viewer-iframe');
        const loading = modal.querySelector('.doc-viewer-loading');
        
        // For PDF files, display directly
        if (extension === 'pdf') {
            iframe.src = fileUrl;
            
            iframe.onload = function() {
                loading.style.display = 'none';
                iframe.style.display = 'block';
            };
            
            iframe.onerror = function() {
                loading.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #dc3545; font-weight: bold; font-size: 18px; margin-bottom: 20px;">‚ö†Ô∏è Cannot preview PDF</p>
                        <p style="color: #888;">Please use the download button above to view the document.</p>
                    </div>
                `;
            };
        } else if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(extension)) {
            // Show download message for Office documents
            let docType = 'Document';
            let icon = 'üìÑ';
            if (['xls', 'xlsx'].includes(extension)) {
                docType = 'Excel Spreadsheet';
                icon = 'üìä';
            } else if (['ppt', 'pptx'].includes(extension)) {
                docType = 'PowerPoint Presentation';
                icon = 'üìä';
            } else if (['doc', 'docx'].includes(extension)) {
                docType = 'Word Document';
                icon = 'üìù';
            }
            
            loading.innerHTML = `
                <div style="text-align: center; padding: 50px 40px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">${icon}</div>
                    <p style="font-size: 20px; color: #333; margin-bottom: 15px; font-weight: 600;">
                        ${docType}
                    </p>
                    <p style="font-size: 16px; color: #666; margin-bottom: 10px;">
                        Cannot view online
                    </p>
                    <p style="color: #888; margin-bottom: 30px;">
                        Please click the <strong style="color: #28a745;">Download</strong> button above to view this document
                    </p>
                </div>
            `;
            iframe.style.display = 'none';
        } else {
            // For other file types, try to display
            iframe.src = fileUrl;
            
            iframe.onload = function() {
                loading.style.display = 'none';
                iframe.style.display = 'block';
            };
            
            iframe.onerror = function() {
                loading.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #dc3545; font-weight: bold; font-size: 18px; margin-bottom: 20px;">‚ö†Ô∏è Cannot preview this file type</p>
                        <p style="color: #888;">Please use the download button above to view the document.</p>
                    </div>
                `;
            };
        };
    }
    
    // Function to download file without opening
    async function downloadFile(url, filename) {
        try {
            const response = await fetch(url, {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': '*/*'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const blob = await response.blob();
            
            // Check if blob is valid
            if (blob.size === 0) {
                throw new Error('Downloaded file is empty');
            }
            
            const blobUrl = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = blobUrl;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(link);
                window.URL.revokeObjectURL(blobUrl);
            }, 100);
        } catch (error) {
            showCustomAlert('Failed to download file: ' + error.message, 'error');
        }
    }
    
    // Custom Alert Modal Function
    function showCustomAlert(message, type = 'info', callback = null) {
        const icons = {
            success: '‚úì',
            error: '‚úï',
            warning: '‚ö†',
            info: '‚Ñπ'
        };

        const titles = {
            success: 'Success',
            error: 'Error',
            warning: 'Warning',
            info: 'Information'
        };

        const overlay = document.createElement('div');
        overlay.className = 'custom-modal-overlay';

        overlay.innerHTML = `
            <div class="custom-modal-content">
                <div class="custom-modal-header ${type}">
                    <div class="custom-modal-icon">${icons[type]}</div>
                    <h3 class="custom-modal-title">${titles[type]}</h3>
                </div>
                <div class="custom-modal-body">
                    ${message}
                </div>
                <div class="custom-modal-footer">
                    <button class="custom-modal-button ${type === 'success' ? 'success' : 'primary'}" onclick="this.closest('.custom-modal-overlay').remove(); ${callback ? '(' + callback.toString() + ')();' : ''}">OK</button>
                </div>
            </div>
        `;

        document.body.appendChild(overlay);

        // Click outside to close
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                overlay.remove();
                if (callback) callback();
            }
        });

        // ESC key to close
        const escHandler = function(e) {
            if (e.key === 'Escape') {
                overlay.remove();
                if (callback) callback();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }

    window.showCustomAlert = showCustomAlert;

    // Custom Confirm Modal Function
    function showCustomConfirm(message, type = 'warning') {
        return new Promise((resolve) => {
            const icons = {
                success: '‚úì',
                error: '‚úï',
                warning: '‚ö†',
                info: '‚Ñπ'
            };

            const titles = {
                success: 'Confirm',
                error: 'Warning',
                warning: 'Confirm Action',
                info: 'Confirmation'
            };

            const overlay = document.createElement('div');
            overlay.className = 'custom-modal-overlay';

            overlay.innerHTML = `
                <div class="custom-modal-content">
                    <div class="custom-modal-header ${type}">
                        <div class="custom-modal-icon">${icons[type]}</div>
                        <h3 class="custom-modal-title">${titles[type]}</h3>
                    </div>
                    <div class="custom-modal-body">
                        ${message}
                    </div>
                    <div class="custom-modal-footer">
                        <button class="custom-modal-button" style="background: #dc3545; color: white;" onclick="this.closest('.custom-modal-overlay').remove(); this.closest('.custom-modal-overlay').userChoice = false;">Cancel</button>
                        <button class="custom-modal-button ${type === 'success' ? 'success' : 'primary'}" onclick="this.closest('.custom-modal-overlay').remove(); this.closest('.custom-modal-overlay').userChoice = true;">Confirm</button>
                    </div>
                </div>
            `;

            overlay.userChoice = false;

            document.body.appendChild(overlay);

            // Click outside to cancel
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.userChoice = false;
                    overlay.remove();
                }
            });

            // ESC key to cancel
            const escHandler = function(e) {
                if (e.key === 'Escape') {
                    overlay.userChoice = false;
                    overlay.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);

            // Wait for modal to be removed, then resolve with user choice
            const observer = new MutationObserver((mutations) => {
                if (!document.body.contains(overlay)) {
                    observer.disconnect();
                    document.removeEventListener('keydown', escHandler);
                    resolve(overlay.userChoice);
                }
            });
            observer.observe(document.body, { childList: true });
        });
    }

    window.showCustomConfirm = showCustomConfirm;

    // Make viewComments function global
    window.viewComments = viewComments;
    window.showDocumentViewer = showDocumentViewer;
    window.downloadFile = downloadFile;
    
    // Print PDF function for iframe content
    window.printPDF = function() {
        const iframe = document.querySelector('.doc-viewer-iframe');
        if (iframe && iframe.contentWindow) {
            iframe.contentWindow.print();
        }
    };

    // Activity tracking for barangay secretaries
    async function updateUserActivity() {
        try {
            await fetch('api/update_activity.php', {
                method: 'POST',
                credentials: 'same-origin'
            });
        } catch (error) {
        }
    }

    // Update activity every 2 minutes
    setInterval(updateUserActivity, 2 * 60 * 1000);

    // Update activity on page visibility change (when user returns to tab)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            updateUserActivity();
        }
    });

    // Update activity on initial load
    updateUserActivity();

  </script>
</body>
</html>