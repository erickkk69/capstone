<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ABC Portal</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 0;
    }

    header {
      background: #004c99;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      box-sizing: border-box;
      height: 70px;
    }

    .header-left, .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      height: 50px;
      width: auto;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      background: white;
      color: black;
      padding: 5px 10px;
      border-radius: 20px;
    }

    /* Main Layout with Fixed Sidebar adjustments */
    .main-layout {
      display: flex;
      margin-top: 70px;
      min-height: calc(100vh - 70px);
    }

    /* FIXED SIDEBAR Styling */
    .sidebar {
      width: 250px;
      background: #e0e0e0;
      padding-top: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      position: fixed;
      top: 70px;
      left: 0;
      height: calc(100vh - 70px);
      overflow-y: auto;
      z-index: 999;
    }

    .sidebar a {
      display: flex; /* align icon + text */
      align-items: center;
      gap: 12px; /* space between icon and text */
      padding: 12px 18px;
      text-decoration: none;
      color: #222;
      font-weight: 600;
      border-left: 5px solid transparent;
      transition: background 0.12s, color 0.12s;
    }

    .sidebar .icon {
      width: 20px;
      height: 20px;
      display: inline-block;
      flex: 0 0 20px;
      color: inherit; /* allow fill via currentColor */
    }

    .sidebar .icon svg { display: block; width: 100%; height: 100%; }

    /* Responsive: collapse sidebar on narrow screens */
    @media (max-width: 800px) {
      .sidebar {
        position: relative;
        width: 100%;
        height: auto;
        display: flex;
        gap: 8px;
        padding: 8px;
        overflow: visible;
      }

      .main-layout { flex-direction: column; margin-top: 70px; }
      .content-area { margin-left: 0; }
      .sidebar a { padding: 10px; }
    }

    .sidebar a:hover, .sidebar a.active {
      background: #cfe4ff; /* subtle blue tint on hover/active */
      color: #003a80; /* darker blue text */
      border-left: 5px solid #0066cc;
    }

    .sidebar:hover a.active {
      background: transparent;
      border-left: 5px solid transparent;
    }

    /* Restore styling when hovering directly over active link */
    .sidebar:hover a.active:hover {
      background: #c0c0c0;
      border-left: 5px solid #0066cc;
    }

    /* Main content area */
    .content-area {
      flex-grow: 1;
      padding: 20px;
      margin-left: 250px;
    }

    /* Card styling */
    .card {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .card:not(.active-card) {
      display: none;
    }

    h2 {
      margin-top: 0;
      color: #004c99; /* Consistent with barangay portal */
      border-bottom: 2px solid #e0e0e0; /* Consistent with barangay portal */
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    h3 {
      color: #333;
      margin-top: 0;
      margin-bottom: 15px;
    }

    /* Table Styling for Professional Look (Copied from barangay portal) */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    th {
      background-color: #f0f0f0;
      color: #333;
      font-weight: bold;
      text-align: left;
      padding: 12px 10px;
      border-bottom: 2px solid #ccc;
    }

    td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    tr:hover {
        background-color: #f9f9f9;
    }

    /* Action Buttons Styling */
    button {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 2px;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    
    .approve {
      background: #28a745;
      color: white;
    }

    .delete {
      background: #dc3545;
      color: white;
    }
    
    /* Dashboard Stats Boxes (Copied from barangay portal) */
    .dashboard-stats {
        display: flex;
        justify-content: space-around;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .stat-box {
        flex: 1;
        min-width: 150px;
        padding: 15px;
        text-align: center;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        background: #f7f7f7;
    }

    .stat-box h3 {
        margin: 0 0 5px 0;
        font-size: 1em;
        color: #666;
    }

    .stat-box p {
        margin: 0;
        font-size: 1.8em;
        font-weight: bold;
        color: #0066cc;
    }

    /* Analytics Dashboard Professional Styling */
    .analytics-section {
        background: linear-gradient(135deg, #f8f9fc 0%, #ffffff 100%);
        border-radius: 12px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: 0 4px 6px rgba(0, 76, 153, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(0, 76, 153, 0.1);
    }

    .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e3e8ef;
    }

    .analytics-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        margin-bottom: 25px;
        padding: 18px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 76, 153, 0.06);
        border: 1px solid #e3e8ef;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 0 1 auto;
    }

    .filter-label {
        font-weight: 600;
        color: #004c99;
        font-size: 0.95em;
        display: flex;
        align-items: center;
        white-space: nowrap;
    }

    .filter-select {
        padding: 10px 35px 10px 15px;
        border: 2px solid #004c99;
        border-radius: 8px;
        font-size: 0.95em;
        font-weight: 500;
        cursor: pointer;
        background: white;
        color: #333;
        transition: all 0.3s ease;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23004c99' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        min-width: 180px;
    }

    .filter-select:hover {
        border-color: #0066cc;
        box-shadow: 0 2px 8px rgba(0, 76, 153, 0.15);
    }

    .filter-select:focus {
        outline: none;
        border-color: #0066cc;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    .filter-result {
        flex: 1;
        text-align: right;
        color: #004c99;
        font-weight: 600;
        font-size: 0.95em;
        padding: 10px 15px;
        background: linear-gradient(135deg, #e8f4f8 0%, #f0f7fa 100%);
        border-radius: 8px;
        border-left: 4px solid #004c99;
        min-width: 200px;
    }

    .chart-container {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 76, 153, 0.08);
        border: 1px solid #e3e8ef;
        position: relative;
    }

    .chart-container canvas {
        max-height: 400px;
    }

    /* Responsive adjustments for analytics */
    @media (max-width: 768px) {
        .analytics-filters {
            flex-direction: column;
            align-items: stretch;
        }
        
        .filter-group {
            flex-direction: column;
            align-items: stretch;
        }
        
        .filter-select {
            width: 100%;
        }
        
        .filter-result {
            text-align: center;
        }
    }

    /* Status Badge Styling (Copied from barangay portal) */
    .status-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 0.85em;
      text-align: center;
    }

    .status-approved {
      background-color: #d4edda;
      color: #155724;
    }

    .status-pending {
      background-color: #cce5ff;
      color: #004085;
    }

    .status-rejected {
      background-color: #f8d7da;
      color: #721c24;
    }

    .status-review {
      background-color: #fff3cd;
      color: #856404;
    }

    /* Comment-related styles */
    .comment-section {
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
    }

    .comment-entry {
      background: white;
      padding: 12px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #dee2e6;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .comment-timestamp {
      font-size: 0.85em;
      color: #6c757d;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .comment-text {
      color: #495057;
      line-height: 1.4;
    }

    .comment-button {
      background: #28a745;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
      transition: background-color 0.2s;
    }

    .comment-button:hover {
      background: #218838;
    }

    .comment-indicator {
      color: #28a745;
      font-size: 0.9em;
    }

    .notification-badge {
      background-color: #dc3545;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 0.75em;
      margin-left: 8px;
      font-weight: bold;
    }

    /* Sidebar notification badge */
    .sidebar-notif-badge {
      background-color: #dc3545;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7em;
      font-weight: bold;
      margin-left: auto;
      display: none;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }

    .sidebar a {
      position: relative;
    }
    
    .user-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .user-form label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
    }

    .user-form input[type="text"],
    .user-form input[type="email"],
    .user-form input[type="password"], 
    .user-form select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }

    .form-actions {
        grid-column: 1 / -1;
        text-align: right;
    }

    .form-actions button {
        padding: 10px 20px;
        font-weight: bold;
    }

    canvas {
      max-width: 100%;
      margin-top: 20px;
    }

    .notifications-hidden {
      display: none !important;
    }

    .toggle-notifications {
      background: #6c757d !important;
      color: white;
    }

    .toggle-notifications:hover {
      background: #545b62 !important;
    }

    .barangay-folder-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .barangay-folder {
        border: 1px solid #ccc;
        border-radius: 5px;
        background: #fff;
        overflow: hidden;
    }

    .barangay-folder-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: #f0f0f0;
        cursor: pointer;
        border-bottom: 1px solid #ccc;
    }
    
    .barangay-folder-header:hover {
        background: #e0e0e0;
    }

    .barangay-folder-name {
        font-weight: bold;
        color: #004c99;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .folder-icon {
        font-size: 1.5em;
    }
    
    .expand-icon {
        font-size: 1.2em;
    }
    
    .expanded .expand-icon {
        transform: rotate(90deg);
    }

    .sub-folder-list {
        padding: 10px 0;
        display: none;
        background: #f9f9f9;
        border-top: 1px solid #eee;
    }
    
    .expanded .sub-folder-list {
        display: block;
    }

    .sub-folder {
        display: block;
        padding: 10px 20px 10px 40px;
        color: #333;
        text-decoration: none;
        cursor: pointer;
    }
    
    .sub-folder-name {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .sub-folder:hover {
        background-color: #e6e6e6;
    }

    /* Alert Box Styling - Professional Design */
    .alert-box {
        padding: 20px;
        margin-bottom: 16px;
        border-radius: 10px;
        border-left: 5px solid;
        display: flex;
        align-items: flex-start;
        gap: 15px;
        box-shadow: 0 3px 8px rgba(0, 76, 153, 0.1), 0 1px 3px rgba(0, 0, 0, 0.06);
        animation: slideIn 0.4s ease-out;
        transition: all 0.3s ease;
        background: white;
    }

    .alert-box:hover {
        box-shadow: 0 5px 15px rgba(0, 76, 153, 0.15), 0 2px 5px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .alert-critical {
        background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
        border-left-color: #dc3545;
    }

    .alert-critical .alert-icon {
        color: #dc3545;
    }

    .alert-critical .alert-title {
        color: #721c24;
    }

    .alert-critical .alert-message {
        color: #721c24;
    }

    .alert-warning {
        background: linear-gradient(135deg, #fffbf0 0%, #ffffff 100%);
        border-left-color: #ffc107;
    }

    .alert-warning .alert-icon {
        color: #ffc107;
    }

    .alert-warning .alert-title {
        color: #856404;
    }

    .alert-warning .alert-message {
        color: #856404;
    }

    .alert-info {
        background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%);
        border-left-color: #17a2b8;
    }

    .alert-info .alert-icon {
        color: #17a2b8;
    }

    .alert-info .alert-title {
        color: #0c5460;
    }

    .alert-info .alert-message {
        color: #0c5460;
    }

    .alert-success {
        background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
        border-left-color: #28a745;
    }

    .alert-success .alert-icon {
        color: #28a745;
    }

    .alert-success .alert-title {
        color: #155724;
    }

    .alert-success .alert-message {
        color: #155724;
    }

    .alert-icon {
        font-size: 2em;
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .alert-content {
        flex-grow: 1;
    }

    .alert-title {
        font-weight: 700;
        margin-bottom: 8px;
        font-size: 1.1em;
        letter-spacing: 0.3px;
    }

    .alert-message {
        font-size: 0.95em;
        line-height: 1.6;
        font-weight: 500;
    }

    .alert-list {
        margin: 12px 0 0 0;
        padding-left: 20px;
        font-size: 0.9em;
        line-height: 1.8;
    }

    .alert-list li {
        margin-bottom: 6px;
        padding-left: 5px;
    }

    .alert-list li em {
        color: #666;
        font-style: normal;
        font-weight: 600;
    }

    /* Decision Support & Alerts Section Styling */
    .alerts-section {
        background: linear-gradient(135deg, #f8f9fc 0%, #ffffff 100%);
        border-radius: 12px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: 0 4px 6px rgba(0, 76, 153, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(0, 76, 153, 0.1);
    }

    .alerts-header {
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e3e8ef;
    }

    .alerts-container {
        margin-top: 20px;
    }

    /* Analysis Cards Styling */
    .analysis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .analysis-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 76, 153, 0.08);
        border: 1px solid rgba(0, 76, 153, 0.1);
        transition: all 0.3s ease;
    }

    .analysis-card:hover {
        box-shadow: 0 4px 12px rgba(0, 76, 153, 0.15);
        transform: translateY(-3px);
    }

    .analysis-card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e3e8ef;
    }

    .analysis-card-icon {
        font-size: 1.5em;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        background: linear-gradient(135deg, #004c99 0%, #0066cc 100%);
        color: white;
    }

    .analysis-card-title {
        font-size: 1.1em;
        font-weight: 700;
        color: #004c99;
    }

    .analysis-metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .analysis-metric:last-child {
        border-bottom: none;
    }

    .analysis-metric-label {
        font-size: 0.9em;
        color: #666;
        font-weight: 500;
    }

    .analysis-metric-value {
        font-size: 1.2em;
        font-weight: 700;
        color: #004c99;
    }

    .analysis-metric-value.positive {
        color: #28a745;
    }

    .analysis-metric-value.negative {
        color: #dc3545;
    }

    .analysis-metric-value.neutral {
        color: #ffc107;
    }

    .trend-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        font-size: 0.85em;
        padding: 4px 8px;
        border-radius: 5px;
        font-weight: 600;
    }

    .trend-up {
        background: #d4edda;
        color: #155724;
    }

    .trend-down {
        background: #f8d7da;
        color: #721c24;
    }

    .trend-stable {
        background: #fff3cd;
        color: #856404;
    }

    .ranking-list {
        list-style: none;
        padding: 0;
        margin: 10px 0;
    }

    .ranking-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin-bottom: 8px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #004c99;
        transition: all 0.2s ease;
    }

    .ranking-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }

    .ranking-number {
        font-size: 1.3em;
        font-weight: 700;
        color: #004c99;
        width: 35px;
        text-align: center;
    }

    .ranking-name {
        flex-grow: 1;
        font-weight: 600;
        color: #333;
    }

    .ranking-score {
        font-weight: 700;
        color: #666;
        font-size: 0.95em;
    }

    .recommendation-box {
        background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
        border-left: 4px solid #2196f3;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
    }

    .recommendation-title {
        font-weight: 700;
        color: #1565c0;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .recommendation-content {
        font-size: 0.95em;
        color: #424242;
        line-height: 1.6;
    }

    .kpi-gauge {
        display: flex;
        align-items: center;
        gap: 15px;
        margin: 15px 0;
    }

    .kpi-gauge-bar {
        flex-grow: 1;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }

    .kpi-gauge-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745 0%, #34d058 100%);
        border-radius: 10px;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 8px;
        color: white;
        font-weight: 600;
        font-size: 0.85em;
    }

    .kpi-gauge-fill.warning {
        background: linear-gradient(90deg, #ffc107 0%, #ffdd57 100%);
    }

    .kpi-gauge-fill.danger {
        background: linear-gradient(90deg, #dc3545 0%, #ff6b6b 100%);
    }

    /* Document Viewer Modal */
    .doc-viewer-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .doc-viewer-container {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 1200px;
        height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .doc-viewer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 2px solid #e0e0e0;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
    }

    .doc-viewer-title {
        font-size: 1.1em;
        font-weight: bold;
        color: #004c99;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-right: 15px;
    }

    .doc-viewer-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .doc-viewer-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .doc-viewer-download {
        background: #28a745;
        color: white;
        text-decoration: none;
    }

    .doc-viewer-download:hover {
        background: #218838;
    }

    .doc-viewer-close {
        background: #dc3545;
        color: white;
    }

    .doc-viewer-close:hover {
        background: #c82333;
    }

    .doc-viewer-content {
        flex: 1;
        overflow: hidden;
        position: relative;
        background: #f5f5f5;
    }

    .doc-viewer-iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    .doc-viewer-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #666;
    }

    .doc-viewer-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #004c99;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Custom Alert Modal */
    .custom-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 99999;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideDown {
        from { 
            transform: translateY(-30px);
            opacity: 0;
        }
        to { 
            transform: translateY(0);
            opacity: 1;
        }
    }

    .custom-modal-content {
        background: white;
        border-radius: 12px;
        padding: 0;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: slideDown 0.3s ease-out;
        overflow: hidden;
    }

    .custom-modal-header {
        background: linear-gradient(135deg, #004c99 0%, #0066cc 100%);
        color: white;
        padding: 20px 25px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .custom-modal-header.success {
        background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);
    }

    .custom-modal-header.error {
        background: linear-gradient(135deg, #dc3545 0%, #e74c5c 100%);
    }

    .custom-modal-header.warning {
        background: linear-gradient(135deg, #ffc107 0%, #ffcd39 100%);
    }

    .custom-modal-icon {
        font-size: 28px;
        line-height: 1;
    }

    .custom-modal-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
        flex: 1;
    }

    .custom-modal-body {
        padding: 25px;
        color: #333;
        font-size: 15px;
        line-height: 1.6;
        max-height: 400px;
        overflow-y: auto;
    }

    .custom-modal-footer {
        padding: 15px 25px;
        background: #f8f9fa;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        border-top: 1px solid #e0e0e0;
    }

    .custom-modal-button {
        padding: 10px 24px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 80px;
    }

    .custom-modal-button.primary {
        background: #004c99;
        color: white;
    }

    .custom-modal-button.primary:hover {
        background: #003d7a;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 76, 153, 0.3);
    }

    .custom-modal-button.success {
        background: #28a745;
        color: white;
    }

    .custom-modal-button.success:hover {
        background: #218838;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

  </style>
  
  <!-- Add libraries for document viewing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <div class="header-left">
      <img src="images/Mbnlg.png" alt="ABC Logo" class="logo">
      <h1>ABC Portal</h1>
    </div>
    <div class="header-right">
      <div class="user-info">
        <span id="userInfoSpan">ABC</span>
      </div>
    </div>
  </header>

  <div class="main-layout">
    <nav class="sidebar">
      <a href="#dashboard" class="sidebar-link active" data-target="dashboard">
        <span class="icon" aria-hidden="true">
          <!-- Dashboard icon -->
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
            <rect x="3" y="3" width="8" height="8" fill="currentColor" rx="1" />
            <rect x="13" y="3" width="8" height="5" fill="currentColor" rx="1" opacity="0.95" />
            <rect x="13" y="10" width="8" height="11" fill="currentColor" rx="1" opacity="0.9" />
            <rect x="3" y="13" width="8" height="7" fill="currentColor" rx="1" opacity="0.9" />
          </svg>
        </span>
        Dashboard
      </a>

      <a href="#users" class="sidebar-link" data-target="users">
        <span class="icon" aria-hidden="true">
          <!-- Users icon -->
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z" fill="currentColor" />
            <path d="M4 20c0-2.21 3.58-4 8-4s8 1.79 8 4v1H4v-1z" fill="currentColor" opacity="0.95" />
          </svg>
        </span>
        User Management
      </a>

      <a href="#manage" class="sidebar-link" data-target="manage">
        <span class="icon" aria-hidden="true">
          <!-- Folder / Submissions icon -->
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
            <path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z" fill="currentColor" />
          </svg>
        </span>
        Manage Submissions
        <span class="sidebar-notif-badge" id="manageNotifBadge">0</span>
      </a>

      <a href="#reset-requests" class="sidebar-link" data-target="reset-requests">
        <span class="icon" aria-hidden="true">
          <!-- Password Reset icon -->
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
            <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM9 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9z" fill="currentColor" />
          </svg>
        </span>
        Password Reset Requests
        <span class="sidebar-notif-badge" id="resetRequestsNotifBadge">0</span>
      </a>

      <a href="index.html" class="logout-link" id="logout-link">
        <span class="icon" aria-hidden="true">
          <!-- Logout icon -->
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
            <path d="M16 13v-2H7V8l-5 4 5 4v-3z" fill="currentColor" />
            <path d="M20 3h-8v2h8v14h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z" fill="currentColor" opacity="0.95" />
          </svg>
        </span>
        Logout
      </a>
    </nav>

    <div class="content-area">
      <div id="dashboard" class="card active-card">
        <h2>Dashboard Overview</h2>
        
        <h3>Document Submission Status</h3>
        <div class="dashboard-stats">
            <div class="stat-box">
                <h3>Total Documents</h3>
                <p id="total-submissions">--</p>
            </div>
            <div class="stat-box">
                <h3>Approved</h3>
                <p id="approved-count">--</p>
            </div>
            <div class="stat-box">
                <h3>Under Review</h3>
                <p id="review-count">--</p>
            </div>
            <div class="stat-box">
                <h3>Pending/Submitted</h3>
                <p id="pending-count">--</p>
            </div>
            <div class="stat-box">
                <h3>Rejected</h3>
                <p id="rejected-count">--</p>
            </div>
        </div>
        
        <hr style="border: 0; height: 1px; background-color: #ccc; margin: 30px 0;">
        
        <!-- Analytics Dashboard Section -->
        <div class="analytics-section">
          <div class="analytics-header">
            <div>
              <h3 style="margin: 0 0 5px 0; color: #004c99; font-size: 1.5em;">üìä Analytics Dashboard</h3>
            </div>
          </div>
          
          <!-- Filters Container -->
          <div class="analytics-filters">
            <div class="filter-group">
              <label for="monthFilter" class="filter-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="vertical-align: middle; margin-right: 5px;">
                  <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                  <path d="M3 10h18M8 2v4M16 2v4" stroke="currentColor" stroke-width="2"/>
                </svg>
                Month:
              </label>
              <select id="monthFilter" class="filter-select">
                <option value="all">All Months</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label for="categoryFilter" class="filter-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="vertical-align: middle; margin-right: 5px;">
                  <path d="M3 3h7v7H3zM14 3h7v7h-7zM3 14h7v7H3zM14 14h7v7h-7z" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
                Category:
              </label>
              <select id="categoryFilter" class="filter-select">
                <option value="all">All Categories</option>
                <option value="administrative">Administrative Document</option>
                <option value="resolutions">Barangay Resolutions/Ordinances</option>
                <option value="plans-budget">Plans and Budget</option>
                <option value="peace-order">Peace and Order</option>
                <option value="social-welfare">Social Welfare</option>
                <option value="sk-reports">SK Reports</option>
                <option value="others">Others / General Document</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label for="periodFilter" class="filter-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="vertical-align: middle; margin-right: 5px;">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                  <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2"/>
                </svg>
                Period:
              </label>
              <select id="periodFilter" class="filter-select">
                <option value="all">All Periods</option>
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="annual">Annual</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label for="statusFilter" class="filter-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="vertical-align: middle; margin-right: 5px;">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                  <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2"/>
                </svg>
                Status:
              </label>
              <select id="statusFilter" class="filter-select">
                <option value="all">All Status</option>
                <option value="approved">‚úì Approved</option>
                <option value="review">‚è≥ Under Review</option>
                <option value="pending">üìù Pending/Submitted</option>
                <option value="rejected">‚úó Rejected</option>
              </select>
            </div>
            
            <div class="filter-result">
              <span id="filteredCount"></span>
            </div>
          </div>
          
          <!-- Chart Container -->
          <div class="chart-container">
            <canvas id="chartSubmissions"></canvas>
          </div>
        </div>
        
        <hr style="border: 0; height: 1px; background-color: #ccc; margin: 30px 0;">
        
        <!-- Decision Support & Alerts Section -->
        <div class="alerts-section">
          <div class="alerts-header">
            <div>
              <h3 style="margin: 0 0 5px 0; color: #004c99; font-size: 1.5em;">üí° Decision Support & Analytics</h3>
            </div>
          </div>
          
          <!-- Analysis Dashboard -->
          <div id="analysis-dashboard" class="analysis-grid">
              <p style="text-align: center; color: #666; font-style: italic; grid-column: 1 / -1;">Loading analysis...</p>
          </div>
          
          <hr style="border: 0; height: 1px; background-color: #e3e8ef; margin: 30px 0;">
          
          <!-- Alerts Container -->
          <div>
              <h4 style="color: #004c99; margin-bottom: 15px; font-size: 1.2em;">üö® Alerts & Notifications</h4>
              <div id="alerts-container" class="alerts-container">
                  <p style="text-align: center; color: #666; font-style: italic;">Loading alerts...</p>
              </div>
          </div>
        </div>
      </div>
      
      <div id="users" class="card">
        <h2>User Management</h2>

        <h3>Add New User</h3>
        <form class="user-form" id="addUserForm">
            <div>
                <label for="userEmail">Email</label>
                <input type="email" id="userEmail" name="userEmail" required>
            </div>
            <div>
                <label for="userBarangay">Barangay</label>
                <select id="userBarangay" name="userBarangay" required>
                    <option value="">Select Barangay</option>
                    <option value="Anilao Proper">Anilao Proper</option>
                    <option value="Anilao East">Anilao East</option>
                    <option value="Bagalangit">Bagalangit</option>
                    <option value="Bulacan">Bulacan</option>
                    <option value="Calamias">Calamias</option>
                    <option value="Estrella">Estrella</option>
                    <option value="Gasang">Gasang</option>
                    <option value="Laurel">Laurel</option>
                    <option value="Ligaya">Ligaya</option>
                    <option value="Mainaga">Mainaga</option>
                    <option value="Mainit">Mainit</option>
                    <option value="Majuben">Majuben</option>
                    <option value="Malimatoc I">Malimatoc I</option>
                    <option value="Malimatoc II">Malimatoc II</option>
                    <option value="Nag-Iba">Nag-Iba</option>
                    <option value="Pilahan">Pilahan</option>
                    <option value="Poblacion">Poblacion</option>
                    <option value="Pulang Lupa">Pulang Lupa</option>
                    <option value="Pulong Anahao">Pulong Anahao</option>
                    <option value="Pulong Balibaguhan">Pulong Balibaguhan</option>
                    <option value="Pulong Niogan">Pulong Niogan</option>
                    <option value="Saguing">Saguing</option>
                    <option value="Sampaguita">Sampaguita</option>
                    <option value="San Francisco">San Francisco</option>
                    <option value="San Jose">San Jose</option>
                    <option value="San Juan">San Juan</option>
                    <option value="San Teodoro">San Teodoro</option>
                    <option value="Santa Ana">Santa Ana</option>
                    <option value="Santa Mesa">Santa Mesa</option>
                    <option value="Santo Ni√±o">Santo Ni√±o</option>
                    <option value="Santo Tomas">Santo Tomas</option>
                    <option value="Solo">Solo</option>
                    <option value="Talaga Proper">Talaga Proper</option>
                    <option value="Talaga East">Talaga East</option>
                </select>
            </div>
      <div>
        <label for="userPassword">Password</label>
        <input type="password" id="userPassword" name="userPassword" minlength="8" required title="Password must be at least 8 characters long">
        <label style="display: block; margin-top: 8px; font-size: 14px;">
          <input type="checkbox" id="showPasswordCheckbox" style="width: auto; margin-right: 5px;">
          Show Password
        </label>
      </div>
      <div>
        <label for="userConfirmPassword">Confirm Password</label>
        <input type="password" id="userConfirmPassword" name="userConfirmPassword" minlength="8" required title="Password must be at least 8 characters long">
      </div>
            <div>
                <label for="userRole">Role</label>
                <input type="text" id="userRole" name="userRole" value="Barangay Secretary" readonly required>
            </div> 
            <div class="form-actions">
                <button type="submit" class="approve">Add User</button>
            </div>
        </form>
        <p id="userMessage" style="color: green; font-weight: bold; margin-bottom: 15px; display: none;"></p>

        <h3>Existing Users</h3>
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Barangay</th>
              <th>Role</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="userTableBody">
            </tbody>
        </table>

        <h3 style="margin-top: 40px;">Archived Users</h3>
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Barangay</th>
              <th>Role</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="archivedUserTableBody">
            </tbody>
        </table>
      </div>

      <div id="manage" class="card">
        <h2>Manage Submissions</h2>
        
        <!-- Search Bar -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
          <input 
            type="text" 
            id="barangay-search" 
            placeholder="Search by barangay name..." 
            style="flex: 1; margin: 0; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95em;"
          />
          <button id="clear-barangay-search" type="button" style="width: auto; padding: 10px 20px; margin: 0; background-color: #ffcccc; color: #000; border: none; cursor: pointer; border-radius: 6px; font-weight: bold;" 
            onmouseover="this.style.backgroundColor='#ff0000'; this.style.color='#fff';" 
            onmouseout="this.style.backgroundColor='#ffcccc'; this.style.color='#000';">Clear</button>
        </div>
        
        <!-- Status Filter Buttons -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
          <button id="manage-filter-all" class="manage-status-filter active" onclick="filterManageSubmissions('all')" style="flex: 1;">
            All Documents (<span id="manage-count-all">0</span>)
          </button>
          <button id="manage-filter-pending" class="manage-status-filter" onclick="filterManageSubmissions('pending')" style="flex: 1;">
            ‚è≥ Pending (<span id="manage-count-pending">0</span>)
          </button>
          <button id="manage-filter-review" class="manage-status-filter" onclick="filterManageSubmissions('review')" style="flex: 1;">
            üîç Under Review (<span id="manage-count-review">0</span>)
          </button>
          <button id="manage-filter-approved" class="manage-status-filter" onclick="filterManageSubmissions('approved')" style="flex: 1;">
            ‚úÖ Approved (<span id="manage-count-approved">0</span>)
          </button>
          <button id="manage-filter-rejected" class="manage-status-filter" onclick="filterManageSubmissions('rejected')" style="flex: 1;">
            ‚ùå Rejected (<span id="manage-count-rejected">0</span>)
          </button>
        </div>
        
        <div class="barangay-folder-list" id="barangay-folders">
            </div>
      </div>

      <!-- Password Reset Requests Section -->
      <div id="reset-requests" class="card">
        <h2>Password Reset Requests</h2>
        
        <!-- Filter Tabs -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px;">
          <button class="reset-filter-btn active" data-filter="pending">
            Pending (<span id="reset-pending-count">0</span>)
          </button>
          <button class="reset-filter-btn" data-filter="approved">
            Approved (<span id="reset-approved-count">0</span>)
          </button>
          <button class="reset-filter-btn" data-filter="rejected">
            Rejected (<span id="reset-rejected-count">0</span>)
          </button>
          <button class="reset-filter-btn" data-filter="all">
            All
          </button>
        </div>

        <!-- Reset Requests Table -->
        <div id="reset-requests-container">
          <table style="width: 100%; border-collapse: collapse; background: white;">
            <thead>
              <tr style="background-color: #f0f0f0;">
                <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Email</th>
                <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Role</th>
                <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Barangay</th>
                <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Requested</th>
                <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Status</th>
                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 180px;">Actions</th>
              </tr>
            </thead>
            <tbody id="reset-requests-tbody">
              <tr>
                <td colspan="6" style="padding: 20px; text-align: center; color: #666;">
                  Loading requests...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      </div>
  </div>

  <!-- Rejection Reason Modal -->
  <div id="rejection-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
      <h3 style="margin-top: 0;">Reject Password Reset Request</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Email: <strong id="reject-modal-email">-</strong>
      </p>
      <p style="margin-bottom: 20px; color: #666;">
        Are you sure you want to reject this password reset request?
      </p>
      <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="closeRejectionModal()" style="padding: 10px 20px; background: #ccc; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
          Cancel
        </button>
        <button onclick="submitRejection()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
          Reject Request
        </button>
      </div>
    </div>
  </div>

  <style>
    .reset-filter-btn {
      padding: 10px 20px;
      border: 2px solid #0066cc;
      background: white;
      color: #0066cc;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .reset-filter-btn:hover {
      background: #e6f2ff;
    }
    .reset-filter-btn.active {
      background: #0066cc;
      color: white;
    }
    /* Modal Status Filter Buttons */
    .modal-status-filter {
      padding: 8px 16px;
      border: 2px solid #ddd;
      background-color: #f8f9fa;
      color: #495057;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    .modal-status-filter:hover {
      background-color: #e9ecef;
      border-color: #007bff;
    }
    .modal-status-filter.active {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }
    .modal-status-filter.active:hover {
      background-color: #0056b3;
      border-color: #0056b3;
    }
    /* Manage Status Filter Buttons */
    .manage-status-filter {
      padding: 10px 20px;
      border: 2px solid #e0e0e0;
      background-color: #ffffff;
      color: #666;
      border-radius: 25px;
      cursor: pointer;
      font-size: 0.95em;
      font-weight: 500;
      transition: all 0.2s ease;
      white-space: nowrap;
      text-align: center;
    }
    .manage-status-filter:hover {
      background-color: #f5f5f5;
      border-color: #0066cc;
    }
    .manage-status-filter.active {
      background-color: #0066cc;
      color: white;
      border-color: #0066cc;
    }
    .manage-status-filter.active:hover {
      background-color: #0052a3;
      border-color: #0052a3;
    }
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: bold;
      display: inline-block;
    }
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    .status-review {
      background: #cce5ff;
      color: #004085;
    }
    .status-approved {
      background: #d4edda;
      color: #155724;
    }
    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9em;
      margin: 0 3px;
    }
    .approve-btn {
      background: #28a745;
      color: white;
    }
    .approve-btn:hover {
      background: #218838;
    }
    .reject-btn {
      background: #dc3545;
      color: white;
    }
    .reject-btn:hover {
      background: #c82333;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Chart will be initialized by updateChart() function

    const barangays = [
        "Anilao Proper", "Anilao East", "Bagalangit", "Bulacan", "Calamias", "Estrella",
        "Gasang", "Laurel", "Ligaya", "Mainaga", "Mainit", "Majuben",
        "Malimatoc I", "Malimatoc II", "Nag-Iba", "Pilahan", "Poblacion", "Pulang Lupa",
        "Pulong Anahao", "Pulong Balibaguhan", "Pulong Niogan", "Saguing", "Sampaguita",
        "San Francisco", "San Jose", "San Juan", "San Teodoro", "Santa Ana",
        "Santa Mesa", "Santo Ni√±o", "Santo Tomas", "Solo", "Talaga Proper", "Talaga East"
    ];

    const subFolderTypes = [
        { name: "Monthly Reports", key: "monthly" },
        { name: "Quarterly Reports", key: "quarterly" },
        { name: "Annual Reports", key: "annual" }
    ];
    
    // Global submissions data
    let allSubmissions = [];
    let currentManageStatusFilter = 'all'; // Track current filter for manage submissions

    // Debounce utility for button clicks - prevents multiple rapid clicks
    function debounce(func, wait = 300) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Button state management - prevents double-clicks
    const buttonStates = new Map();
    
    function isButtonBusy(buttonElement) {
      return buttonStates.get(buttonElement) === true;
    }
    
    function setButtonBusy(buttonElement, isBusy) {
      if (isBusy) {
        buttonStates.set(buttonElement, true);
        buttonElement.disabled = true;
        buttonElement.style.opacity = '0.6';
        buttonElement.style.cursor = 'wait';
      } else {
        buttonStates.delete(buttonElement);
        buttonElement.disabled = false;
        buttonElement.style.opacity = '1';
        buttonElement.style.cursor = 'pointer';
      }
    }

    // Helper function to update sidebar notification badges
    function updateSidebarBadge(badgeId, count) {
        const badge = document.getElementById(badgeId);
        if (badge) {
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
    }

    // Load all submissions
    async function loadAllSubmissions() {
        const indicator = document.getElementById('autoRefreshIndicator');
        try {
            // Show refreshing state
            if (indicator) indicator.classList.add('refreshing');
            
            const response = await fetch('api/submissions.php');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.ok && Array.isArray(result.submissions)) {
                allSubmissions = result.submissions;
                
                // Update dashboard stats with proper counting
                const total = allSubmissions.length;
                const approved = allSubmissions.filter(s => s.status && s.status.toLowerCase().trim() === 'approved').length;
                const review = allSubmissions.filter(s => s.status && s.status.toLowerCase().trim() === 'review').length;
                const pending = allSubmissions.filter(s => {
                    if (!s.status) return false;
                    const statusLower = s.status.toLowerCase().trim();
                    return statusLower === 'pending' || statusLower === 'submitted';
                }).length;
                const rejected = allSubmissions.filter(s => s.status && s.status.toLowerCase().trim() === 'rejected').length;
                
                // Force update the DOM elements
                const totalEl = document.getElementById('total-submissions');
                const approvedEl = document.getElementById('approved-count');
                const reviewEl = document.getElementById('review-count');
                const pendingEl = document.getElementById('pending-count');
                const rejectedEl = document.getElementById('rejected-count');
                
                if (totalEl) totalEl.textContent = total;
                if (approvedEl) approvedEl.textContent = approved;
                if (reviewEl) reviewEl.textContent = review;
                if (pendingEl) pendingEl.textContent = pending;
                if (rejectedEl) rejectedEl.textContent = rejected;
                
                // Update sidebar badge for Manage Submissions (show pending + review count)
                const actionNeeded = pending + review;
                updateSidebarBadge('manageNotifBadge', actionNeeded);
                
                // Populate month filter dropdown (this will also update the chart)
                populateMonthFilter();
                
                // Generate analysis dashboard
                generateAnalysisDashboard();
                
                // Generate alerts
                generateAlerts();
                
                // Render folders
                renderBarangayFolders();
            } else {
                // Set zero values if data is invalid
                document.getElementById('total-submissions').textContent = '0';
                document.getElementById('approved-count').textContent = '0';
                document.getElementById('review-count').textContent = '0';
                document.getElementById('pending-count').textContent = '0';
                document.getElementById('rejected-count').textContent = '0';
            }
        } catch (error) {
            // Set error state
            document.getElementById('total-submissions').textContent = 'Error';
            document.getElementById('approved-count').textContent = 'Error';
            document.getElementById('review-count').textContent = 'Error';
            document.getElementById('pending-count').textContent = 'Error';
            document.getElementById('rejected-count').textContent = 'Error';
        } finally {
            // Remove refreshing state
            if (indicator) indicator.classList.remove('refreshing');
        }
    }
    
    // Update document submission status stats
    function updateDocumentStats(filteredSubmissions) {
        const total = filteredSubmissions.length;
        const approved = filteredSubmissions.filter(s => s.status && s.status.toLowerCase().trim() === 'approved').length;
        const review = filteredSubmissions.filter(s => s.status && s.status.toLowerCase().trim() === 'review').length;
        const pending = filteredSubmissions.filter(s => {
            if (!s.status) return false;
            const statusLower = s.status.toLowerCase().trim();
            return statusLower === 'pending' || statusLower === 'submitted';
        }).length;
        const rejected = filteredSubmissions.filter(s => s.status && s.status.toLowerCase().trim() === 'rejected').length;
        
        const totalEl = document.getElementById('total-submissions');
        const approvedEl = document.getElementById('approved-count');
        const reviewEl = document.getElementById('review-count');
        const pendingEl = document.getElementById('pending-count');
        const rejectedEl = document.getElementById('rejected-count');
        
        if (totalEl) totalEl.textContent = total;
        if (approvedEl) approvedEl.textContent = approved;
        if (reviewEl) reviewEl.textContent = review;
        if (pendingEl) pendingEl.textContent = pending;
        if (rejectedEl) rejectedEl.textContent = rejected;
    }
    
    // Update chart with submission data
    function updateChart(selectedMonth = 'all', selectedStatus = 'all', selectedCategory = 'all', selectedPeriod = 'all') {
        // Filter submissions by selected month, status, category, and period
        let filteredSubmissions = allSubmissions;
        
        // Apply month filter
        if (selectedMonth !== 'all') {
            filteredSubmissions = filteredSubmissions.filter(s => {
                // Try multiple date fields: submission_date, uploaded_at, created_at
                const dateValue = s.submission_date || s.uploaded_at || s.created_at;
                if (!dateValue) return false;
                const submissionDate = new Date(dateValue);
                const monthYear = `${submissionDate.getFullYear()}-${String(submissionDate.getMonth() + 1).padStart(2, '0')}`;
                return monthYear === selectedMonth;
            });
        }
        
        // Apply category filter
        if (selectedCategory !== 'all') {
            filteredSubmissions = filteredSubmissions.filter(s => {
                if (!s.category) return false;
                return s.category.toLowerCase().trim() === selectedCategory.toLowerCase().trim();
            });
        }
        
        // Apply period filter
        if (selectedPeriod !== 'all') {
            filteredSubmissions = filteredSubmissions.filter(s => {
                if (!s.period && !s.reporting_period) return false;
                const period = (s.period || s.reporting_period).toLowerCase().trim();
                return period === selectedPeriod.toLowerCase().trim();
            });
        }
        
        // Apply status filter
        if (selectedStatus !== 'all') {
            filteredSubmissions = filteredSubmissions.filter(s => {
                if (!s.status) return false;
                const statusLower = s.status.toLowerCase().trim();
                
                if (selectedStatus === 'pending') {
                    return statusLower === 'pending' || statusLower === 'submitted';
                }
                return statusLower === selectedStatus;
            });
        }
        
        // Update filtered count display
        const filteredCountEl = document.getElementById('filteredCount');
        if (filteredCountEl) {
            let filterDescription = '';
            
            if (selectedMonth === 'all' && selectedStatus === 'all' && selectedCategory === 'all' && selectedPeriod === 'all') {
                filterDescription = `Showing all ${allSubmissions.length} submissions`;
            } else {
                let parts = [];
                
                if (selectedMonth !== 'all') {
                    const monthName = new Date(selectedMonth + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    parts.push(monthName);
                }
                
                if (selectedCategory !== 'all') {
                    const categoryNames = {
                        'administrative': 'Administrative',
                        'resolutions': 'Resolutions/Ordinances',
                        'plans-budget': 'Plans & Budget',
                        'peace-order': 'Peace & Order',
                        'social-welfare': 'Social Welfare',
                        'sk-reports': 'SK Reports',
                        'others': 'Others'
                    };
                    parts.push(categoryNames[selectedCategory] || selectedCategory);
                }
                
                if (selectedPeriod !== 'all') {
                    const periodNames = {
                        'monthly': 'Monthly',
                        'quarterly': 'Quarterly',
                        'annual': 'Annual'
                    };
                    parts.push(periodNames[selectedPeriod] || selectedPeriod);
                }
                
                if (selectedStatus !== 'all') {
                    const statusNames = {
                        'approved': 'Approved',
                        'review': 'Under Review',
                        'pending': 'Pending/Submitted',
                        'rejected': 'Rejected'
                    };
                    parts.push(statusNames[selectedStatus]);
                }
                
                filterDescription = `Showing ${filteredSubmissions.length} ${parts.join(' - ')} submissions`;
            }
            
            filteredCountEl.textContent = filterDescription;
        }
        
        const submissionsByBarangay = {};
        
        barangays.forEach(barangay => {
            submissionsByBarangay[barangay] = filteredSubmissions.filter(s => s.barangay === barangay).length;
        });
        
        const ctx = document.getElementById('chartSubmissions').getContext('2d');
        if (window.submissionsChart) {
            window.submissionsChart.destroy();
        }
        
        window.submissionsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: barangays,
                datasets: [{
                    label: 'Submissions by Barangay',
                    data: barangays.map(b => submissionsByBarangay[b]),
                    backgroundColor: 'rgba(0, 102, 204, 0.7)',
                    borderColor: 'rgba(0, 102, 204, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
        
        // Update document submission status, analysis dashboard and alerts with filtered data
        updateDocumentStats(filteredSubmissions);
        generateAnalysisDashboard(filteredSubmissions);
        generateAlerts(filteredSubmissions);
    }
    
    // Populate month filter dropdown with available months from submissions
    function populateMonthFilter() {
        const monthFilter = document.getElementById('monthFilter');
        const statusFilter = document.getElementById('statusFilter');
        const categoryFilter = document.getElementById('categoryFilter');
        const periodFilter = document.getElementById('periodFilter');
        
        if (!monthFilter) {
            return;
        }
        
        // Extract unique months from submissions
        const monthsSet = new Set();
        allSubmissions.forEach(s => {
            // Try multiple date fields: submission_date, uploaded_at, created_at
            const dateValue = s.submission_date || s.uploaded_at || s.created_at;
            if (dateValue) {
                const date = new Date(dateValue);
                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthsSet.add(monthYear);
            }
        });
        
        // Convert to array and sort in descending order (newest first)
        const months = Array.from(monthsSet).sort().reverse();
        
        // Clear existing options except "All Months"
        monthFilter.innerHTML = '<option value="all">All Months</option>';
        
        // Add month options
        months.forEach(monthYear => {
            const date = new Date(monthYear + '-01');
            const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const option = document.createElement('option');
            option.value = monthYear;
            option.textContent = monthName;
            monthFilter.appendChild(option);
        });
        
        // Add event listeners for filter changes
        const updateFilters = function() {
            const selectedMonth = monthFilter ? monthFilter.value : 'all';
            const selectedStatus = statusFilter ? statusFilter.value : 'all';
            const selectedCategory = categoryFilter ? categoryFilter.value : 'all';
            const selectedPeriod = periodFilter ? periodFilter.value : 'all';
            updateChart(selectedMonth, selectedStatus, selectedCategory, selectedPeriod);
        };
        
        monthFilter.onchange = updateFilters;
        
        if (statusFilter) {
            statusFilter.onchange = updateFilters;
        }
        
        if (categoryFilter) {
            categoryFilter.onchange = updateFilters;
        }
        
        if (periodFilter) {
            periodFilter.onchange = updateFilters;
        }
        
        // Auto-select the most recent month if available and update chart
        if (months.length > 0) {
            monthFilter.value = months[0]; // Select the latest month
            // Trigger initial chart update with selected month
            updateFilters();
        } else {
            // If no months available, still show chart with all data
            updateChart('all', 'all', 'all', 'all');
        }
    }
    
    // Generate comprehensive analysis dashboard
    function generateAnalysisDashboard(filteredSubmissions = null) {
        const analysisContainer = document.getElementById('analysis-dashboard');
        if (!analysisContainer) return;
        
        // Use filtered submissions if provided, otherwise use all submissions
        const submissions = filteredSubmissions || allSubmissions;
        
        const totalBarangays = barangays.length;
        const activeBarangays = barangays.filter(b => submissions.some(s => s.barangay === b)).length;
        const totalSubmissions = submissions.length;
        
        // Calculate key metrics
        const approved = submissions.filter(s => s.status && s.status.toLowerCase().trim() === 'approved').length;
        const review = submissions.filter(s => s.status && s.status.toLowerCase().trim() === 'review').length;
        const pending = submissions.filter(s => {
            if (!s.status) return false;
            const statusLower = s.status.toLowerCase().trim();
            return statusLower === 'pending' || statusLower === 'submitted';
        }).length;
        const rejected = submissions.filter(s => s.status && s.status.toLowerCase().trim() === 'rejected').length;
        
        // Calculate rates
        const approvalRate = totalSubmissions > 0 ? ((approved / totalSubmissions) * 100).toFixed(1) : 0;
        const rejectionRate = totalSubmissions > 0 ? ((rejected / totalSubmissions) * 100).toFixed(1) : 0;
        const participationRate = ((activeBarangays / totalBarangays) * 100).toFixed(1);
        const avgSubmissionsPerBarangay = activeBarangays > 0 ? (totalSubmissions / activeBarangays).toFixed(1) : 0;
        
        // Time-based analysis
        const now = new Date();
        const last30Days = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        const recentSubmissions = submissions.filter(s => {
            const dateValue = s.submission_date || s.uploaded_at || s.created_at;
            if (!dateValue) return false;
            return new Date(dateValue) >= last30Days;
        }).length;
        
        // Performance rankings - prioritize by number of approved documents
        const barangayPerformance = barangays.map(barangay => {
            const barangaySubmissions = submissions.filter(s => s.barangay === barangay);
            const approvedCount = barangaySubmissions.filter(s => s.status && s.status.toLowerCase().trim() === 'approved').length;
            const totalCount = barangaySubmissions.length;
            return { barangay, totalCount, approvedCount };
        }).filter(item => item.approvedCount > 0)
          .sort((a, b) => b.approvedCount - a.approvedCount || b.totalCount - a.totalCount);
        
        const topPerformers = barangayPerformance.slice(0, 5);
        const needsAttention = barangays.filter(b => 
            !submissions.some(s => s.barangay === b) ||
            submissions.filter(s => s.barangay === b).length < 2
        ).slice(0, 5);
        
        // Generate HTML
        let html = '';
        
        // Card 1: Key Performance Indicators
        html += `
            <div class="analysis-card">
                <div class="analysis-card-header">
                    <div class="analysis-card-icon">üìä</div>
                    <div class="analysis-card-title">Key Performance Indicators</div>
                </div>
                <div class="analysis-metric">
                    <span class="analysis-metric-label">Participation Rate</span>
                    <span class="analysis-metric-value ${participationRate >= 75 ? 'positive' : participationRate >= 50 ? 'neutral' : 'negative'}">${participationRate}%</span>
                </div>
                <div class="analysis-metric">
                    <span class="analysis-metric-label">Approval Rate</span>
                    <span class="analysis-metric-value ${approvalRate >= 70 ? 'positive' : approvalRate >= 50 ? 'neutral' : 'negative'}">${approvalRate}%</span>
                </div>
                <div class="analysis-metric">
                    <span class="analysis-metric-label">Avg. Submissions per Barangay</span>
                    <span class="analysis-metric-value">${avgSubmissionsPerBarangay}</span>
                </div>
                <div class="analysis-metric">
                    <span class="analysis-metric-label">Recent Activity (30 days)</span>
                    <span class="analysis-metric-value">${recentSubmissions} submissions</span>
                </div>
            </div>
        `;
        
        // Card 2: Statistical Summary
        const inProgressCount = pending + review;
        const completionRate = totalSubmissions > 0 ? (((approved + rejected) / totalSubmissions) * 100).toFixed(1) : 0;
        
        html += `
            <div class="analysis-card">
                <div class="analysis-card-header">
                    <div class="analysis-card-icon">üìà</div>
                    <div class="analysis-card-title">Statistical Summary</div>
                </div>
                <div class="analysis-metric">
                    <span class="analysis-metric-label">Total Submissions</span>
                    <span class="analysis-metric-value">${totalSubmissions}</span>
                </div>
                <div class="analysis-metric">
                    <span class="analysis-metric-label">Completion Rate</span>
                    <span class="analysis-metric-value ${completionRate >= 60 ? 'positive' : 'neutral'}">${completionRate}%</span>
                </div>
                <div class="analysis-metric">
                    <span class="analysis-metric-label">In Progress</span>
                    <span class="analysis-metric-value neutral">${inProgressCount}</span>
                </div>
                <div class="analysis-metric">
                    <span class="analysis-metric-label">Rejection Rate</span>
                    <span class="analysis-metric-value ${rejectionRate > 20 ? 'negative' : rejectionRate > 10 ? 'neutral' : 'positive'}">${rejectionRate}%</span>
                </div>
                <div class="analysis-metric">
                    <span class="analysis-metric-label">Active Barangays</span>
                    <span class="analysis-metric-value">${activeBarangays} / ${totalBarangays}</span>
                </div>
            </div>
        `;
        
        // Card 3: Top Performers
        html += `
            <div class="analysis-card">
                <div class="analysis-card-header">
                    <div class="analysis-card-icon">üèÜ</div>
                    <div class="analysis-card-title">Top Performing Barangays</div>
                </div>
                ${topPerformers.length > 0 ? `
                    <ul class="ranking-list">
                        ${topPerformers.map((item, index) => `
                            <li class="ranking-item">
                                <span class="ranking-number">#${index + 1}</span>
                                <span class="ranking-name">${item.barangay}</span>
                                <span class="ranking-score">${item.approvedCount}/${item.totalCount}</span>
                            </li>
                        `).join('')}
                    </ul>
                ` : '<p style="text-align: center; color: #666; font-style: italic; padding: 20px 0;">No performance data available yet</p>'}
            </div>
        `;
        
        // Card 4: Needs Attention
        html += `
            <div class="analysis-card">
                <div class="analysis-card-header">
                    <div class="analysis-card-icon">‚ö†Ô∏è</div>
                    <div class="analysis-card-title">Requires Attention</div>
                </div>
                ${needsAttention.length > 0 ? `
                    <ul class="ranking-list">
                        ${needsAttention.map((barangay, index) => {
                            const count = allSubmissions.filter(s => s.barangay === barangay).length;
                            return `
                                <li class="ranking-item" style="border-left-color: #dc3545;">
                                    <span class="ranking-number" style="color: #dc3545;">${index + 1}</span>
                                    <span class="ranking-name">${barangay}</span>
                                    <span class="ranking-score" style="color: #dc3545;">${count} docs</span>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                ` : '<p style="text-align: center; color: #666; font-style: italic; padding: 20px 0;">All barangays are performing well!</p>'}
            </div>
        `;
        
        // Card 5: Trend Analysis
        const trendDirection = recentSubmissions > (totalSubmissions / 2) ? 'up' : recentSubmissions < (totalSubmissions / 4) ? 'down' : 'stable';
        const trendText = trendDirection === 'up' ? 'Increasing' : trendDirection === 'down' ? 'Decreasing' : 'Stable';
        const trendIcon = trendDirection === 'up' ? '‚Üó' : trendDirection === 'down' ? '‚Üò' : '‚Üí';
        
        html += `
            <div class="analysis-card">
                <div class="analysis-card-header">
                    <div class="analysis-card-icon">üìâ</div>
                    <div class="analysis-card-title">Trend Analysis</div>
                </div>
                <div class="analysis-metric">
                    <span class="analysis-metric-label">Activity Trend</span>
                    <span class="trend-indicator trend-${trendDirection}">${trendIcon} ${trendText}</span>
                </div>
                <div class="analysis-metric">
                    <span class="analysis-metric-label">Recent vs Total</span>
                    <span class="analysis-metric-value">${recentSubmissions}/${totalSubmissions}</span>
                </div>
            </div>
        `;
        
        // Card 6: Actionable Recommendations
        const recommendations = [];
        
        if (participationRate < 60) {
            recommendations.push('üì¢ Launch outreach campaign to inactive barangays');
        }
        if (rejectionRate > 15) {
            recommendations.push('üìã Provide training on document requirements');
        }
        if (pending + review > totalSubmissions * 0.3) {
            recommendations.push('‚è±Ô∏è Prioritize review of pending submissions');
        }
        if (recentSubmissions < totalSubmissions * 0.2 && totalSubmissions > 0) {
            recommendations.push('üì£ Send reminder notifications to barangays');
        }
        if (approvalRate >= 70 && participationRate >= 75) {
            recommendations.push('üéâ Recognize high-performing barangays publicly');
        }
        if (recommendations.length === 0) {
            recommendations.push('‚úÖ Continue monitoring submission patterns');
        }
        
        html += `
            <div class="analysis-card">
                <div class="analysis-card-header">
                    <div class="analysis-card-icon">üí°</div>
                    <div class="analysis-card-title">Strategic Recommendations</div>
                </div>
                ${recommendations.map(rec => `
                    <div class="recommendation-box">
                        <div class="recommendation-title">
                            <span>${rec.split(' ')[0]}</span>
                        </div>
                        <div class="recommendation-content">
                            ${rec.substring(rec.indexOf(' ') + 1)}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        
        analysisContainer.innerHTML = html;
    }
    
    // Generate decision support and alerts based on submission data
    function generateAlerts(filteredSubmissions = null) {
        const alertsContainer = document.getElementById('alerts-container');
        if (!alertsContainer) return;
        
        // Use filtered submissions if provided, otherwise use all submissions
        const submissions = filteredSubmissions || allSubmissions;
        
        const alerts = [];
        
        // 1. Check for barangays with no submissions
        const barangaysWithNoSubmissions = barangays.filter(barangay => 
            !submissions.some(s => s.barangay === barangay)
        );
        
        if (barangaysWithNoSubmissions.length > 0) {
            alerts.push({
                type: 'critical',
                icon: 'üö®',
                title: 'Barangays with Zero Submissions',
                message: `${barangaysWithNoSubmissions.length} barangay(s) have not submitted any documents yet (in filtered results).`,
                list: barangaysWithNoSubmissions.slice(0, 5),
                extra: barangaysWithNoSubmissions.length > 5 ? `and ${barangaysWithNoSubmissions.length - 5} more...` : null
            });
        }
        
        // 2. Check for pending/submitted status that needs review
        const pendingSubmissions = submissions.filter(s => 
            s.status && (s.status.toLowerCase() === 'pending' || s.status.toLowerCase() === 'submitted')
        );
        
        if (pendingSubmissions.length > 0) {
            const barangaysWithPending = [...new Set(pendingSubmissions.map(s => s.barangay))];
            alerts.push({
                type: 'warning',
                icon: '‚è≥',
                title: 'Pending Submissions Require Action',
                message: `${pendingSubmissions.length} submission(s) are waiting for review from ${barangaysWithPending.length} barangay(s).`,
                list: barangaysWithPending.slice(0, 5),
                extra: barangaysWithPending.length > 5 ? `and ${barangaysWithPending.length - 5} more...` : null
            });
        }
        
        // 3. Check for barangays with low submission counts
        const submissionCounts = barangays.map(barangay => ({
            barangay,
            count: submissions.filter(s => s.barangay === barangay).length
        })).filter(item => item.count > 0 && item.count < 3);
        
        if (submissionCounts.length > 0) {
            alerts.push({
                type: 'warning',
                icon: '‚ö†Ô∏è',
                title: 'Low Submission Activity',
                message: `${submissionCounts.length} barangay(s) have submitted fewer than 3 documents.`,
                list: submissionCounts.slice(0, 5).map(item => `${item.barangay} (${item.count})`),
                extra: submissionCounts.length > 5 ? `and ${submissionCounts.length - 5} more...` : null
            });
        }
        
        // 4. Check for rejected submissions
        const rejectedSubmissions = submissions.filter(s => 
            s.status && s.status.toLowerCase() === 'rejected'
        );
        
        if (rejectedSubmissions.length > 0) {
            const barangaysWithRejected = [...new Set(rejectedSubmissions.map(s => s.barangay))];
            alerts.push({
                type: 'info',
                icon: 'üìã',
                title: 'Rejected Submissions',
                message: `${rejectedSubmissions.length} submission(s) have been rejected from ${barangaysWithRejected.length} barangay(s).`,
                list: barangaysWithRejected.slice(0, 5),
                extra: barangaysWithRejected.length > 5 ? `and ${barangaysWithRejected.length - 5} more...` : null
            });
        }
        
        // 5. Check for high-performing barangays
        const highPerformers = barangays.map(barangay => {
            const barangaySubmissions = submissions.filter(s => s.barangay === barangay);
            const approved = barangaySubmissions.filter(s => s.status && s.status.toLowerCase() === 'approved').length;
            return { barangay, count: barangaySubmissions.length, approved };
        }).filter(item => item.count >= 5 && item.approved >= 3);
        
        if (highPerformers.length > 0) {
            alerts.push({
                type: 'success',
                icon: '‚úÖ',
                title: 'High-Performing Barangays',
                message: `${highPerformers.length} barangay(s) have excellent submission records.`,
                list: highPerformers.slice(0, 5).map(item => `${item.barangay} (${item.count} total, ${item.approved} approved)`),
                extra: highPerformers.length > 5 ? `and ${highPerformers.length - 5} more...` : null
            });
        }
        
        // 6. Overall status summary
        const totalBarangays = barangays.length;
        const activeBarangays = barangays.filter(b => submissions.some(s => s.barangay === b)).length;
        const completionRate = ((activeBarangays / totalBarangays) * 100).toFixed(1);
        
        alerts.push({
            type: 'info',
            icon: 'üìä',
            title: 'Overall Submission Status',
            message: `${activeBarangays} out of ${totalBarangays} barangays (${completionRate}%) have submitted documents.`,
            list: null,
            extra: null
        });
        
        // Render alerts
        if (alerts.length === 0) {
            alertsContainer.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No alerts at this time.</p>';
            return;
        }
        
        let html = '';
        alerts.forEach(alert => {
            html += `
                <div class="alert-box alert-${alert.type}">
                    <div class="alert-icon">${alert.icon}</div>
                    <div class="alert-content">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-message">${alert.message}</div>
                        ${alert.list ? `
                            <ul class="alert-list">
                                ${alert.list.map(item => `<li>${item}</li>`).join('')}
                                ${alert.extra ? `<li><em>${alert.extra}</em></li>` : ''}
                            </ul>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        
        alertsContainer.innerHTML = html;
    }
    
    // Function to show rejection reason prompt
    function showRejectPrompt() {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 8px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                ">
                    <h3 style="margin: 0 0 15px 0; color: #dc3545; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">‚ùå</span>
                        Rejection Reason Required
                    </h3>
                    <p style="margin: 0 0 20px 0; color: #555;">
                        Please provide a reason for rejecting this submission. This will be automatically added as a comment.
                    </p>
                    <textarea id="reject-reason-input" 
                        placeholder="Example: Missing required documents, Incomplete information, Does not meet requirements, etc."
                        style="
                            width: 100%;
                            min-height: 100px;
                            padding: 12px;
                            border: 2px solid #ddd;
                            border-radius: 6px;
                            font-size: 14px;
                            font-family: inherit;
                            resize: vertical;
                            box-sizing: border-box;
                        "
                    ></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                        <button id="reject-cancel-btn" style="
                            padding: 10px 20px;
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                        ">Cancel</button>
                        <button id="reject-submit-btn" style="
                            padding: 10px 20px;
                            background: #dc3545;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                        ">Confirm Rejection</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const textarea = modal.querySelector('#reject-reason-input');
            const cancelBtn = modal.querySelector('#reject-cancel-btn');
            const submitBtn = modal.querySelector('#reject-submit-btn');
            
            // Focus on textarea
            textarea.focus();
            
            // Handle cancel
            cancelBtn.onclick = () => {
                modal.remove();
                resolve(null);
            };
            
            // Handle submit
            submitBtn.onclick = () => {
                const reason = textarea.value.trim();
                if (!reason) {
                    textarea.style.borderColor = '#dc3545';
                    textarea.placeholder = 'Rejection reason is required!';
                    return;
                }
                modal.remove();
                resolve(reason);
            };
            
            // Handle Enter key (Ctrl+Enter to submit)
            textarea.onkeydown = (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    submitBtn.click();
                }
            };
            
            // Close on background click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    cancelBtn.click();
                }
            };
        });
    }
    
    // Update submission status with debouncing
    async function updateSubmissionStatus(id, status, remarks = '', event = null) {
        // Get button element if event is provided
        let btn = null;
        if (event && event.target) {
            btn = event.target.closest('button, select, a');
            if (btn && isButtonBusy(btn)) {
                return;
            }
            if (btn) setButtonBusy(btn, true);
        }
        
        // If status is rejected, require a rejection reason
        if (status === 'rejected' && !remarks) {
            if (btn) setButtonBusy(btn, false);
            
            // Show prompt for rejection reason
            const reason = await showRejectPrompt();
            
            if (!reason || reason.trim() === '') {
                // User cancelled or provided empty reason
                return;
            }
            
            // Add rejection reason as a comment with timestamp
            const currentUser = document.getElementById('userInfoSpan').textContent || 'ABC';
            const timestamp = new Date().toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            remarks = `[${currentUser} - ${timestamp}] ‚ùå REJECTED: ${reason.trim()}`;
        }
        
        try {
            // Add timestamp to the status change
            const currentDateTime = new Date().toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            
            const response = await fetch('api/submissions.php', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    id, 
                    status, 
                    remarks,
                    status_changed_at: currentDateTime
                })
            });
            
            const result = await response.json();
            
            if (result.ok) {
                showCustomAlert('Status updated successfully at ' + currentDateTime, 'success');
                await loadAllSubmissions();
                
                // Auto-update the modal if it's currently open
                updateModalStatusIfOpen(id, status, currentDateTime);
                
                // Immediately update badge count when status changes to approved or rejected
                if (status === 'approved' || status === 'rejected') {
                    // Recalculate badge count (pending + review only)
                    const actionNeeded = allSubmissions.filter(s => {
                        if (!s.status) return false;
                        const statusLower = s.status.toLowerCase().trim();
                        return (statusLower === 'pending' || statusLower === 'submitted' || statusLower === 'review') && s.id !== id;
                    }).length;
                    updateSidebarBadge('manageNotifBadge', actionNeeded);
                }
            } else {
                showCustomAlert('Error: ' + (result.error || 'Failed to update status'), 'error');
            }
        } catch (error) {
            showCustomAlert('Failed to update status', 'error');
        } finally {
            if (btn) setButtonBusy(btn, false);
        }
    }
    
    // Function to update status in open modal
    function updateModalStatusIfOpen(submissionId, newStatus, timestamp) {
        // Find all status badges and dropdowns in open modals
        const openModals = document.querySelectorAll('div[style*="position: fixed"]');
        
        openModals.forEach(modal => {
            // Find the row for this submission
            const rows = modal.querySelectorAll('tr');
            rows.forEach(row => {
                // Check if this row contains a select with the submission ID
                const select = row.querySelector(`select[onchange*="updateSubmissionStatus(${submissionId}"]`);
                if (select) {
                    // Update the data-status attribute so filtering works correctly
                    row.setAttribute('data-status', newStatus);
                    
                    // Update the status badge in this row
                    const statusCell = row.querySelector('td:nth-child(4)');
                    if (statusCell) {
                        const statusBadge = statusCell.querySelector('.status-badge');
                        if (statusBadge) {
                            // Update badge class
                            statusBadge.className = 'status-badge';
                            const statusClass = {
                                'pending': 'status-pending',
                                'review': 'status-review',
                                'approved': 'status-approved',
                                'rejected': 'status-rejected'
                            }[newStatus] || 'status-pending';
                            statusBadge.classList.add(statusClass);
                            
                            // Update badge text
                            const statusText = {
                                'pending': 'Pending',
                                'review': 'Under Review',
                                'approved': 'Approved',
                                'rejected': 'Rejected'
                            }[newStatus] || newStatus;
                            statusBadge.textContent = statusText;
                        }
                        
                        // Add or update timestamp below status badge
                        let timestampDiv = statusCell.querySelector('.status-timestamp');
                        if (!timestampDiv) {
                            timestampDiv = document.createElement('div');
                            timestampDiv.className = 'status-timestamp';
                            timestampDiv.style.cssText = 'font-size: 0.75em; color: #007bff; margin-top: 4px; font-weight: bold;';
                            statusCell.appendChild(timestampDiv);
                        }
                        timestampDiv.innerHTML = `üïí ${timestamp}`;
                    }
                    
                    // Reset the dropdown
                    select.value = '';
                    
                    // Update the modal filter counts
                    updateModalFilterCounts(modal);
                    
                    // Re-apply current filter to show/hide the row properly
                    const activeFilter = modal.querySelector('.modal-status-filter.active');
                    if (activeFilter) {
                        const currentFilter = activeFilter.getAttribute('data-status');
                        if (currentFilter && currentFilter !== 'all') {
                            // Hide the row if it doesn't match the current filter
                            if (newStatus !== currentFilter) {
                                row.style.display = 'none';
                            } else {
                                row.style.display = '';
                            }
                        }
                    }
                }
            });
        });
    }
    
    // Function to update modal filter counts
    function updateModalFilterCounts(modal) {
        const rows = modal.querySelectorAll('.modal-submission-row');
        const counts = {
            all: 0,
            pending: 0,
            review: 0,
            approved: 0,
            rejected: 0
        };
        
        rows.forEach(row => {
            const status = row.getAttribute('data-status');
            counts.all++;
            if (counts.hasOwnProperty(status)) {
                counts[status]++;
            }
        });
        
        // Update count displays
        const countAllElement = modal.querySelector('.modal-count-all');
        const countPendingElement = modal.querySelector('.modal-count-pending');
        const countReviewElement = modal.querySelector('.modal-count-review');
        const countApprovedElement = modal.querySelector('.modal-count-approved');
        const countRejectedElement = modal.querySelector('.modal-count-rejected');
        
        if (countAllElement) countAllElement.textContent = counts.all;
        if (countPendingElement) countPendingElement.textContent = counts.pending;
        if (countReviewElement) countReviewElement.textContent = counts.review;
        if (countApprovedElement) countApprovedElement.textContent = counts.approved;
        if (countRejectedElement) countRejectedElement.textContent = counts.rejected;
    }
    
    // Make status update function global
    window.updateSubmissionStatus = updateSubmissionStatus;
    
    // Render barangay folders with submissions
    function renderBarangayFolders() {
        const folderContainer = document.getElementById('barangay-folders');
        if (!folderContainer) {
            return;
        }
        
        folderContainer.innerHTML = '';
        
        // Update filter counts
        updateManageFilterCounts();

        // Get filtered submissions based on current status filter
        let submissionsToDisplay = allSubmissions;
        if (currentManageStatusFilter !== 'all') {
            submissionsToDisplay = allSubmissions.filter(s => s.status === currentManageStatusFilter);
        }

        // Sort barangays by submission count (descending) - barangays with submissions first
        const sortedBarangays = [...barangays].sort((a, b) => {
            const aCount = submissionsToDisplay.filter(s => s.barangay === a).length;
            const bCount = submissionsToDisplay.filter(s => s.barangay === b).length;
            return bCount - aCount; // Descending order
        });

        sortedBarangays.forEach(barangay => {
            const barangaySubmissions = submissionsToDisplay.filter(s => s.barangay === barangay);
            
            // Skip barangays with no submissions for current filter
            if (barangaySubmissions.length === 0) {
                return;
            }
            
            const folder = document.createElement('div');
            folder.className = 'barangay-folder';
            
            const header = document.createElement('div');
            header.className = 'barangay-folder-header';
            
            header.onclick = function() {
                folder.classList.toggle('expanded');
            };

            const nameSpan = document.createElement('span');
            nameSpan.className = 'barangay-folder-name';
            nameSpan.innerHTML = `<span class="folder-icon">üìÅ</span> ${barangay} <span style="font-size: 0.85em; color: #666;">(${barangaySubmissions.length} submissions)</span>`;

            const expandIcon = document.createElement('span');
            expandIcon.className = 'expand-icon';
            expandIcon.innerHTML = '&#9654;';

            header.appendChild(nameSpan);
            header.appendChild(expandIcon);
            
            const subFolderList = document.createElement('div');
            subFolderList.className = 'sub-folder-list';

            // Group submissions by period
            subFolderTypes.forEach(type => {
                const periodSubmissions = barangaySubmissions.filter(s => s.period === type.key);
                
                const subFolder = document.createElement('div');
                subFolder.className = 'sub-folder';
                
                const subFolderName = document.createElement('span');
                subFolderName.className = 'sub-folder-name';
                subFolderName.innerHTML = `<span class="folder-icon" style="font-size: 1.2em;">üìÑ</span> ${type.name} (${periodSubmissions.length})`;

                subFolder.appendChild(subFolderName);
                
                subFolder.onclick = (e) => {
                    e.stopPropagation(); 
                    showSubmissionModal(barangay, type.name, periodSubmissions);
                };

                subFolderList.appendChild(subFolder);
            });
            
            folder.appendChild(header);
            folder.appendChild(subFolderList);
            folderContainer.appendChild(folder);
        });
        
        // Show message if no results
        if (folderContainer.children.length === 0) {
            folderContainer.innerHTML = `
                <div style="padding: 40px; text-align: center; color: #666; background: #f8f9fa; border-radius: 8px; border: 2px dashed #ddd;">
                    <div style="font-size: 3em; margin-bottom: 15px;">üìÅ</div>
                    <h3 style="margin: 0 0 10px 0; color: #495057;">No ${currentManageStatusFilter === 'all' ? '' : currentManageStatusFilter + ' '}submissions found</h3>
                    <p style="margin: 0; font-size: 0.9em;">Try selecting a different filter or check back later.</p>
                </div>
            `;
        }
    }
    
    // Update manage filter counts
    function updateManageFilterCounts() {
        document.getElementById('manage-count-all').textContent = allSubmissions.length;
        document.getElementById('manage-count-pending').textContent = allSubmissions.filter(s => s.status === 'pending').length;
        document.getElementById('manage-count-review').textContent = allSubmissions.filter(s => s.status === 'review').length;
        document.getElementById('manage-count-approved').textContent = allSubmissions.filter(s => s.status === 'approved').length;
        document.getElementById('manage-count-rejected').textContent = allSubmissions.filter(s => s.status === 'rejected').length;
    }
    
    // Filter manage submissions by status
    window.filterManageSubmissions = function(status) {
        currentManageStatusFilter = status;
        
        // Update active button
        document.querySelectorAll('.manage-status-filter').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById('manage-filter-' + status).classList.add('active');
        
        // Re-render folders with filtered data
        renderBarangayFolders();
        
        // Reset search if active
        const searchInput = document.getElementById('barangay-search');
        if (searchInput && searchInput.value.trim() !== '') {
            filterBarangayFolders(searchInput.value.toLowerCase().trim());
        }
    };
    
    // Search functionality for barangay folders
    function initializeBarangaySearch() {
        const searchInput = document.getElementById('barangay-search');
        const clearButton = document.getElementById('clear-barangay-search');
        
        if (!searchInput || !clearButton) {
            return;
        }
        
        // Search functionality
        const debouncedSearch = debounce(function() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            filterBarangayFolders(searchTerm);
        }, 300);
        
        searchInput.addEventListener('input', debouncedSearch);
        
        // Clear button functionality
        clearButton.addEventListener('click', function() {
            searchInput.value = '';
            filterBarangayFolders('');
        });
    }
    
    // Filter barangay folders based on search term
    function filterBarangayFolders(searchTerm) {
        const folderContainer = document.getElementById('barangay-folders');
        if (!folderContainer) return;
        
        const folders = folderContainer.querySelectorAll('.barangay-folder');
        
        if (searchTerm === '') {
            // Show all folders
            folders.forEach(folder => {
                folder.style.display = 'block';
            });
            return;
        }
        
        folders.forEach(folder => {
            const barangayNameElement = folder.querySelector('.barangay-folder-name');
            const barangayName = barangayNameElement ? barangayNameElement.textContent.toLowerCase() : '';
            
            // Get the barangay name from the folder
            const actualBarangayName = barangays.find(b => barangayName.includes(b.toLowerCase()));
            
            if (!actualBarangayName) {
                folder.style.display = 'none';
                return;
            }
            
            // Check if barangay name matches search term
            const barangayMatches = actualBarangayName.toLowerCase().includes(searchTerm);
            
            // Show/hide folder based on barangay name match only
            if (barangayMatches) {
                folder.style.display = 'block';
            } else {
                folder.style.display = 'none';
            }
        });
    }
    
    // Show submissions in a modal
    function showSubmissionModal(barangay, period, submissions) {
        if (submissions.length === 0) {
            showCustomAlert(`No ${period} submissions for ${barangay}`, 'info');
            return;
        }
        
        // Count submissions by status
        const statusCounts = {
            all: submissions.length,
            pending: submissions.filter(s => s.status === 'pending').length,
            review: submissions.filter(s => s.status === 'review').length,
            approved: submissions.filter(s => s.status === 'approved').length,
            rejected: submissions.filter(s => s.status === 'rejected').length
        };
        
        // Determine which filter should be active based on the current main filter
        const initialFilter = currentManageStatusFilter === 'all' ? 'all' : currentManageStatusFilter;
        
        let html = `
            <div id="submission-modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                    <h2>${barangay} - ${period}</h2>
                    
                    <!-- Status Filter Buttons -->
                    <div style="margin: 20px 0; display: flex; gap: 8px; flex-wrap: wrap; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px;">
                        <button class="modal-status-filter ${initialFilter === 'all' ? 'active' : ''}" data-status="all" onclick="filterModalSubmissions('all')">
                            All (<span class="modal-count-all">${statusCounts.all}</span>)
                        </button>
                        <button class="modal-status-filter ${initialFilter === 'pending' ? 'active' : ''}" data-status="pending" onclick="filterModalSubmissions('pending')">
                            ‚è≥ Pending (<span class="modal-count-pending">${statusCounts.pending}</span>)
                        </button>
                        <button class="modal-status-filter ${initialFilter === 'review' ? 'active' : ''}" data-status="review" onclick="filterModalSubmissions('review')">
                            üîç Review (<span class="modal-count-review">${statusCounts.review}</span>)
                        </button>
                        <button class="modal-status-filter ${initialFilter === 'approved' ? 'active' : ''}" data-status="approved" onclick="filterModalSubmissions('approved')">
                            ‚úÖ Approved (<span class="modal-count-approved">${statusCounts.approved}</span>)
                        </button>
                        <button class="modal-status-filter ${initialFilter === 'rejected' ? 'active' : ''}" data-status="rejected" onclick="filterModalSubmissions('rejected')">
                            ‚ùå Rejected (<span class="modal-count-rejected">${statusCounts.rejected}</span>)
                        </button>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 10px; background: #f0f0f0; border-bottom: 2px solid #ccc;">Title</th>
                                <th style="text-align: left; padding: 10px; background: #f0f0f0; border-bottom: 2px solid #ccc;">Category</th>
                                <th style="text-align: left; padding: 10px; background: #f0f0f0; border-bottom: 2px solid #ccc;">Date</th>
                                <th style="text-align: left; padding: 10px; background: #f0f0f0; border-bottom: 2px solid #ccc;">Status</th>
                                <th style="text-align: left; padding: 10px; background: #f0f0f0; border-bottom: 2px solid #ccc;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="modal-submissions-tbody">
        `;
        
        submissions.forEach(sub => {
            const statusClass = {
                'pending': 'status-pending',
                'review': 'status-review',
                'approved': 'status-approved',
                'rejected': 'status-rejected'
            }[sub.status] || 'status-pending';
            
            const statusText = {
                'pending': 'Pending',
                'review': 'Under Review',
                'approved': 'Approved',
                'rejected': 'Rejected'
            }[sub.status] || sub.status;
            
            const date = new Date(sub.created_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            // Format status change timestamp if available
            let statusChangedTime = '';
            if (sub.status_changed_at) {
                statusChangedTime = `<br><small style="color: #007bff; font-weight: bold; font-size: 0.75em;">üïí ${sub.status_changed_at}</small>`;
            }
            
            const hasComments = sub.remarks && sub.remarks.trim() !== '';
            const commentIndicator = hasComments ? ' üí¨' : '';
            const commentCount = hasComments ? (sub.remarks.split('[').length - 1) : 0;
            
            // Get latest comment for preview
            let latestComment = '';
            if (hasComments) {
                const entries = sub.remarks.split('\n\n').filter(entry => entry.trim() !== '');
                if (entries.length > 0) {
                    const lastEntry = entries[entries.length - 1];
                    const match = lastEntry.match(/^\[([^\]]+)\]\s*(.*)$/s);
                    if (match) {
                        latestComment = match[2].substring(0, 50) + (match[2].length > 50 ? '...' : '');
                    } else {
                        latestComment = lastEntry.substring(0, 50) + (lastEntry.length > 50 ? '...' : '');
                    }
                }
            }
            
            html += `
                <tr class="modal-submission-row" data-status="${sub.status}" style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;">
                        ${sub.title}${commentIndicator}
                        ${hasComments ? `<br><small style="color: #6c757d; font-style: italic;">Latest: "${latestComment}"</small>` : ''}
                    </td>
                    <td style="padding: 10px;">${sub.category}</td>
                    <td style="padding: 10px;">${date}</td>
                    <td style="padding: 10px;"><span class="status-badge ${statusClass}">${statusText}</span>${statusChangedTime}</td>
                    <td style="padding: 10px;">
                        <a href="javascript:void(0)" onclick="showDocumentViewer('${sub.filename}', '${sub.title}')" style="color: #0066cc; margin-right: 10px; cursor: pointer; text-decoration: none;">üìÑ View</a>
                        <button onclick="showCommentModal(${sub.id}, '${sub.title}', '${sub.barangay}')" style="padding: 4px 8px; background: ${hasComments ? '#17a2b8' : '#28a745'}; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 0.85em;" title="${hasComments ? 'View and manage comments' : 'Add a comment'}">üí¨ ${hasComments ? 'Comments (' + commentCount + ')' : 'Comment'}</button>
                        <select onchange="if(this.value) { updateSubmissionStatus(${sub.id}, this.value); this.value=''; }" style="padding: 4px; border: 1px solid #ccc; border-radius: 4px; margin-left: 5px;">
                            <option value="">üìù Change Status</option>
                            <option value="pending">‚è≥ Pending</option>
                            <option value="review">üîç Under Review</option>
                            <option value="approved">‚úÖ Approve</option>
                            <option value="rejected">‚ùå Reject</option>
                        </select>
                    </td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                    
                    <!-- Show summary of comments if any exist -->
                    ${(() => {
                        const hasComments = submissions.some(sub => sub.remarks && sub.remarks.trim() !== '');
                        if (hasComments) {
                            const totalComments = submissions.reduce((total, sub) => {
                                if (sub.remarks && sub.remarks.trim() !== '') {
                                    return total + (sub.remarks.split('[').length - 1);
                                }
                                return total;
                            }, 0);
                            return `
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #28a745;">
                                    <strong>üí¨ Comments Summary:</strong> ${totalComments} comment(s) across ${submissions.filter(sub => sub.remarks && sub.remarks.trim() !== '').length} submission(s)
                                </div>
                            `;
                        }
                        return '';
                    })()}
                    
                    <div style="text-align: right; margin-top: 20px;">
                        <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
        
        // Apply the initial filter after modal is inserted
        if (initialFilter !== 'all') {
            // Use setTimeout to ensure the DOM is ready
            setTimeout(() => {
                filterModalSubmissions(initialFilter);
            }, 10);
        }
    }
    
    // Filter submissions within modal by status
    window.filterModalSubmissions = function(status) {
        const modalRows = document.querySelectorAll('.modal-submission-row');
        const filterButtons = document.querySelectorAll('.modal-status-filter');
        
        // Update active button
        filterButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-status') === status) {
                btn.classList.add('active');
            }
        });
        
        // Filter rows
        let visibleCount = 0;
        modalRows.forEach(row => {
            const rowStatus = row.getAttribute('data-status');
            if (status === 'all' || rowStatus === status) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Show message if no submissions for selected filter
        const tbody = document.getElementById('modal-submissions-tbody');
        if (tbody) {
            const existingNoResults = tbody.querySelector('.no-results-row');
            if (existingNoResults) {
                existingNoResults.remove();
            }
            
            if (visibleCount === 0) {
                const noResultsRow = document.createElement('tr');
                noResultsRow.className = 'no-results-row';
                noResultsRow.innerHTML = `
                    <td colspan="5" style="padding: 20px; text-align: center; color: #666; font-style: italic;">
                        No ${status === 'all' ? '' : status} submissions found
                    </td>
                `;
                tbody.appendChild(noResultsRow);
            }
        }
    };
    
    window.showSubmissionModal = showSubmissionModal;
    
    // Format comments for display
    function formatComments(remarksText) {
        if (!remarksText || remarksText.trim() === '') {
            return '<em style="color: #6c757d;">No comments or remarks yet.</em>';
        }
        
        // Split by double newlines to separate different comment entries
        const entries = remarksText.split('\n\n').filter(entry => entry.trim() !== '');
        
        if (entries.length === 0) {
            return '<em style="color: #6c757d;">No comments or remarks yet.</em>';
        }
        
        let formattedHtml = '';
        entries.forEach((entry, index) => {
            // Check if entry has timestamp format [datetime]
            const timestampMatch = entry.match(/^\[([^\]]+)\]\s*(.*)$/s);
            
            if (timestampMatch) {
                const timestamp = timestampMatch[1];
                const content = timestampMatch[2].trim();
                
                formattedHtml += `
                    <div class="comment-entry" style="background: white; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #dee2e6;">
                        <div class="comment-timestamp" style="font-size: 0.85em; color: #6c757d; font-weight: bold; margin-bottom: 5px;">
                            üïí ${timestamp}
                        </div>
                        <div class="comment-text" style="color: #495057; line-height: 1.4;">
                            ${content.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
            } else {
                // Entry without timestamp - legacy format
                formattedHtml += `
                    <div class="comment-entry" style="background: white; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #dee2e6;">
                        <div class="comment-text" style="color: #495057; line-height: 1.4;">
                            ${entry.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
            }
        });
        
        return formattedHtml;
    }
    
    // Show comment modal for a specific submission
    async function showCommentModal(submissionId, title, barangay) {
        try {
            // Get current submission details and comments
            const response = await fetch(`api/submissions.php?id=${submissionId}`);
            const result = await response.json();
            
            if (!result.ok) {
                showCustomAlert('Error loading submission details: ' + (result.error || 'Unknown error'), 'error');
                return;
            }
            
            const submission = result.submission || {};
            const currentRemarks = submission.remarks || '';
            
            let html = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; padding: 30px; border-radius: 8px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h2 style="margin-top: 0; color: #004c99;">üí¨ Comments & Remarks</h2>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                            <strong>Submission:</strong> ${title}<br>
                            <strong>Barangay:</strong> ${barangay}<br>
                            <strong>Status:</strong> <span class="status-badge status-${submission.status || 'pending'}">${submission.status || 'Pending'}</span>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #495057; font-size: 1.1em; margin-bottom: 10px;">üìù Current Comments/Remarks:</h3>
                            <div id="current-remarks" style="background: #f8f9fa; padding: 15px; border-radius: 6px; min-height: 60px; border: 1px solid #dee2e6; max-height: 300px; overflow-y: auto;">
                                ${formatComments(currentRemarks)}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #495057; font-size: 1.1em; margin-bottom: 10px;">‚ûï Add New Comment/Remark:</h3>
                            <textarea id="new-comment" placeholder="Enter your comment or remarks here..." style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; font-family: Arial, sans-serif; resize: vertical; box-sizing: border-box;"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                            <button onclick="addComment(${submissionId})" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">üí¨ Add Comment</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        } catch (error) {
            showCustomAlert('Error loading comment modal: ' + error.message, 'error');
        }
    }
    
    // Add comment to submission with debouncing
    async function addComment(submissionId, event = null) {
        const commentTextarea = document.getElementById('new-comment');
        const newComment = commentTextarea.value.trim();
        
        if (!newComment) {
            showCustomAlert('Please enter a comment before adding.', 'warning');
            return;
        }
        
        // Get button and prevent double-click
        let btn = null;
        if (event && event.target) {
            btn = event.target.closest('button');
            if (btn && isButtonBusy(btn)) {
                return;
            }
            if (btn) {
                setButtonBusy(btn, true);
                btn.textContent = 'Adding...';
            }
        }
        
        try {
            // Get current remarks
            const currentRemarksDiv = document.getElementById('current-remarks');
            const currentRemarksText = currentRemarksDiv.innerHTML.includes('<em') ? '' : currentRemarksDiv.textContent;
            
            // Combine existing and new remarks
            const currentDateTime = new Date().toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const newRemarkEntry = `[${currentDateTime}] ${newComment}`;
            const updatedRemarks = currentRemarksText ? 
                currentRemarksText + '\n\n' + newRemarkEntry : 
                newRemarkEntry;
            
            // Update submission with new remarks
            const response = await fetch('api/submissions.php', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    id: submissionId, 
                    action: 'add_comment',
                    remarks: updatedRemarks 
                })
            });
            
            const result = await response.json();
            
            if (result.ok) {
                // Update the current remarks display with formatted comments
                currentRemarksDiv.innerHTML = formatComments(updatedRemarks);
                
                // Clear the textarea
                commentTextarea.value = '';
                
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.style.cssText = 'background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin: 10px 0; text-align: center;';
                successMsg.textContent = '‚úÖ Comment added successfully!';
                commentTextarea.parentElement.insertBefore(successMsg, commentTextarea);
                
                // Remove success message after 3 seconds
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.remove();
                    }
                }, 3000);
                
                // Refresh submissions data
                await loadAllSubmissions();
            } else {
                showCustomAlert('Error adding comment: ' + (result.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            showCustomAlert('Failed to add comment: ' + error.message, 'error');
        } finally {
            const addBtn = document.querySelector('button[onclick*="addComment"]');
            if (addBtn) {
                addBtn.textContent = 'Add Comment';
                addBtn.disabled = false;
                addBtn.style.opacity = '1';
                addBtn.style.cursor = 'pointer';
            }
        }
    }
    
    // Function to show document viewer modal
    function showDocumentViewer(filename, title) {
        const modal = document.createElement('div');
        modal.className = 'doc-viewer-modal';
        modal.onclick = function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        };
        
        // Get file extension to determine how to display
        const extension = filename.split('.').pop().toLowerCase();
        // Use absolute path from root to ensure it works when hosted
        const baseUrl = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '/');
        const fileUrl = `${baseUrl}api/view_file.php?file=${encodeURIComponent(filename)}`;
        const downloadUrl = `${baseUrl}api/view_file.php?file=${encodeURIComponent(filename)}&download=1`;
        
        // Create proper download filename with extension
        const downloadFilename = title && !title.includes('.') ? `${title}.${extension}` : (title || filename);
        
        modal.innerHTML = `
            <div class="doc-viewer-container" onclick="event.stopPropagation()">
                <div class="doc-viewer-header">
                    <div class="doc-viewer-title">
                        üìÑ ${title || filename}
                    </div>
                    <div class="doc-viewer-actions">
                        <button class="doc-viewer-btn doc-viewer-download" onclick="downloadFile('${downloadUrl}', '${downloadFilename.replace(/'/g, "\\'")}')">
                            ‚¨áÔ∏è Download
                        </button>
                        <button class="doc-viewer-btn doc-viewer-close" onclick="this.closest('.doc-viewer-modal').remove()">
                            ‚úñ Close
                        </button>
                    </div>
                </div>
                <div class="doc-viewer-content">
                    <div class="doc-viewer-loading">
                        <div class="doc-viewer-spinner"></div>
                        <p>Loading document...</p>
                    </div>
                    <iframe class="doc-viewer-iframe" src="" style="display: none;"></iframe>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Load the document
        const iframe = modal.querySelector('.doc-viewer-iframe');
        const loading = modal.querySelector('.doc-viewer-loading');
        const content = modal.querySelector('.doc-viewer-content');
        
        // fileUrl is already an absolute URL
        const fullFileUrl = fileUrl;
        
        // Handle different file types
        if (extension === 'pdf') {
            // Display PDF directly in iframe with embed fallback
            iframe.src = fileUrl + '#view=FitH';
            
            let loaded = false;
            iframe.onload = function() {
                if (!loaded) {
                    loaded = true;
                    setTimeout(() => {
                        loading.style.display = 'none';
                        iframe.style.display = 'block';
                    }, 500);
                }
            };
            
            // Check if PDF loaded after 3 seconds
            setTimeout(() => {
                if (!loaded) {
                    // Try embed method
                    const embed = document.createElement('embed');
                    embed.src = fileUrl;
                    embed.type = 'application/pdf';
                    embed.style.width = '100%';
                    embed.style.height = '100%';
                    content.innerHTML = '';
                    content.appendChild(embed);
                    setTimeout(() => {
                        loading.style.display = 'none';
                    }, 1000);
                }
            }, 3000);
        } else if (extension === 'docx' || extension === 'doc') {
            // Show download message for Word documents
            loading.innerHTML = `
                <div style="text-align: center; padding: 50px 40px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">üìù</div>
                    <p style="font-size: 20px; color: #333; margin-bottom: 15px; font-weight: 600;">
                        Word Document
                    </p>
                    <p style="font-size: 16px; color: #666; margin-bottom: 10px;">
                        Cannot view online
                    </p>
                    <p style="color: #888; margin-bottom: 30px;">
                        Please click the <strong style="color: #28a745;">Download</strong> button above to view this document
                    </p>
                </div>
            `;
        } else if (['xls', 'xlsx'].includes(extension)) {
            // Show download message for Excel documents
            loading.innerHTML = `
                <div style="text-align: center; padding: 50px 40px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">üìä</div>
                    <p style="font-size: 20px; color: #333; margin-bottom: 15px; font-weight: 600;">
                        Excel Spreadsheet
                    </p>
                    <p style="font-size: 16px; color: #666; margin-bottom: 10px;">
                        Cannot view online
                    </p>
                    <p style="color: #888; margin-bottom: 30px;">
                        Please click the <strong style="color: #28a745;">Download</strong> button above to view this document
                    </p>
                </div>
            `;
        } else if (['ppt', 'pptx'].includes(extension)) {
            // Show download message for PowerPoint documents
            loading.innerHTML = `
                <div style="text-align: center; padding: 50px 40px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">üìä</div>
                    <p style="font-size: 20px; color: #333; margin-bottom: 15px; font-weight: 600;">
                        PowerPoint Presentation
                    </p>
                    <p style="font-size: 16px; color: #666; margin-bottom: 10px;">
                        Cannot view online
                    </p>
                    <p style="color: #888; margin-bottom: 30px;">
                        Please click the <strong style="color: #28a745;">Download</strong> button above to view this document
                    </p>
                </div>
            `;
        } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(extension)) {
            // Display images directly
            const img = document.createElement('img');
            img.src = fileUrl;
            img.style.maxWidth = '100%';
            img.style.maxHeight = '100%';
            img.style.objectFit = 'contain';
            img.style.display = 'block';
            img.style.margin = 'auto';
            img.onload = function() {
                loading.style.display = 'none';
                content.appendChild(img);
            };
            img.onerror = function() {
                loading.innerHTML = `
                    <p style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è Cannot load image</p>
                    <p>Please use the download button above to view the file.</p>
                `;
            };
        } else if (['txt', 'csv', 'json', 'xml', 'log'].includes(extension)) {
            // Display text files directly
            fetch(fileUrl)
                .then(response => response.text())
                .then(text => {
                    const pre = document.createElement('pre');
                    pre.style.padding = '20px';
                    pre.style.margin = '0';
                    pre.style.overflow = 'auto';
                    pre.style.height = '100%';
                    pre.style.backgroundColor = '#f5f5f5';
                    pre.style.whiteSpace = 'pre-wrap';
                    pre.style.wordWrap = 'break-word';
                    pre.textContent = text;
                    loading.style.display = 'none';
                    content.appendChild(pre);
                })
                .catch(() => {
                    loading.innerHTML = `
                        <p style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è Cannot preview this file</p>
                        <p>Please use the download button above to view the document.</p>
                    `;
                });
        } else if (['mp4', 'webm', 'ogg'].includes(extension)) {
            // Display video files
            const video = document.createElement('video');
            video.src = fileUrl;
            video.controls = true;
            video.style.maxWidth = '100%';
            video.style.maxHeight = '100%';
            video.style.display = 'block';
            video.style.margin = 'auto';
            video.onloadedmetadata = function() {
                loading.style.display = 'none';
                content.appendChild(video);
            };
            video.onerror = function() {
                loading.innerHTML = `
                    <p style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è Cannot play video</p>
                    <p>Please use the download button above to view the file.</p>
                `;
            };
        } else if (['mp3', 'wav', 'ogg', 'm4a'].includes(extension)) {
            // Display audio files
            const audio = document.createElement('audio');
            audio.src = fileUrl;
            audio.controls = true;
            audio.style.width = '100%';
            audio.style.margin = '20px auto';
            audio.style.display = 'block';
            audio.onloadedmetadata = function() {
                loading.style.display = 'none';
                content.appendChild(audio);
            };
            audio.onerror = function() {
                loading.innerHTML = `
                    <p style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è Cannot play audio</p>
                    <p>Please use the download button above to view the file.</p>
                `;
            };
        } else {
            // For unknown file types, show download prompt
            loading.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">üìÑ</div>
                    <h3 style="color: #004c99; margin-bottom: 10px;">Document Preview Not Available</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        File type: <strong>.${extension}</strong>
                    </p>
                    <p style="color: #666; margin-bottom: 30px;">
                        This file type cannot be previewed in the browser. Please download to view.
                    </p>
                    <button onclick="window.open('${downloadUrl}', '_blank')" style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 6px;
                        font-size: 16px;
                        cursor: pointer;
                        font-weight: bold;
                    ">
                        üì• Download File
                    </button>
                </div>
            `;
        }
    }
    
    // Function to download file without opening
    async function downloadFile(url, filename) {
        try {
            const response = await fetch(url, {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': '*/*'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const blob = await response.blob();
            
            // Check if blob is valid
            if (blob.size === 0) {
                throw new Error('Downloaded file is empty');
            }
            
            const blobUrl = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = blobUrl;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(link);
                window.URL.revokeObjectURL(blobUrl);
            }, 100);
        } catch (error) {
            console.error('Download error:', error);
            showCustomAlert('Failed to download file: ' + error.message, 'error');
        }
    }
    
    // Make functions global
    window.showCommentModal = showCommentModal;
    window.addComment = addComment;
    window.showDocumentViewer = showDocumentViewer;
    window.downloadFile = downloadFile;
    
    // Function to open file in native application
    function openFileInNativeApp(filepath, filename) {
        // Extract file extension to get proper filename
        const extension = filepath.split('.').pop().toLowerCase();
        
        // Get filename from path if not provided
        if (!filename || filename === 'undefined') {
            const pathParts = filepath.split('/');
            filename = pathParts[pathParts.length - 1];
        } else {
            // Make sure filename has the correct extension
            if (!filename.toLowerCase().endsWith('.' + extension)) {
                filename = filename + '.' + extension;
            }
        }
        
        // Create a temporary link element to trigger download
        const link = document.createElement('a');
        link.href = filepath;
        link.download = filename; // This triggers download instead of opening in browser
        link.style.display = 'none';
        
        // Add to DOM, click it, then remove
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    window.openFileInNativeApp = openFileInNativeApp;

    // Custom Alert Modal Function
    function showCustomAlert(message, type = 'info', callback = null) {
        const icons = {
            success: '‚úì',
            error: '‚úï',
            warning: '‚ö†',
            info: '‚Ñπ'
        };

        const titles = {
            success: 'Success',
            error: 'Error',
            warning: 'Warning',
            info: 'Information'
        };

        const overlay = document.createElement('div');
        overlay.className = 'custom-modal-overlay';

        overlay.innerHTML = `
            <div class="custom-modal-content">
                <div class="custom-modal-header ${type}">
                    <div class="custom-modal-icon">${icons[type]}</div>
                    <h3 class="custom-modal-title">${titles[type]}</h3>
                </div>
                <div class="custom-modal-body">
                    ${message}
                </div>
                <div class="custom-modal-footer">
                    <button class="custom-modal-button ${type === 'success' ? 'success' : 'primary'}" onclick="this.closest('.custom-modal-overlay').remove(); ${callback ? '(' + callback.toString() + ')();' : ''}">OK</button>
                </div>
            </div>
        `;

        document.body.appendChild(overlay);

        // Click outside to close
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                overlay.remove();
                if (callback) callback();
            }
        });

        // ESC key to close
        const escHandler = function(e) {
            if (e.key === 'Escape') {
                overlay.remove();
                if (callback) callback();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }

    window.showCustomAlert = showCustomAlert;

    // Custom Confirm Modal Function
    function showCustomConfirm(message, type = 'warning') {
        return new Promise((resolve) => {
            const icons = {
                success: '‚úì',
                error: '‚úï',
                warning: '‚ö†',
                info: '‚Ñπ'
            };

            const titles = {
                success: 'Confirm',
                error: 'Warning',
                warning: 'Confirm Action',
                info: 'Confirmation'
            };

            const overlay = document.createElement('div');
            overlay.className = 'custom-modal-overlay';

            overlay.innerHTML = `
                <div class="custom-modal-content">
                    <div class="custom-modal-header ${type}">
                        <div class="custom-modal-icon">${icons[type]}</div>
                        <h3 class="custom-modal-title">${titles[type]}</h3>
                    </div>
                    <div class="custom-modal-body">
                        ${message}
                    </div>
                    <div class="custom-modal-footer">
                        <button class="custom-modal-button" style="background: #dc3545; color: white;" onclick="this.closest('.custom-modal-overlay').remove(); this.closest('.custom-modal-overlay').userChoice = false;">Cancel</button>
                        <button class="custom-modal-button ${type === 'success' ? 'success' : 'primary'}" onclick="this.closest('.custom-modal-overlay').remove(); this.closest('.custom-modal-overlay').userChoice = true;">Confirm</button>
                    </div>
                </div>
            `;

            overlay.userChoice = false;

            document.body.appendChild(overlay);

            // Click outside to cancel
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.userChoice = false;
                    overlay.remove();
                }
            });

            // ESC key to cancel
            const escHandler = function(e) {
                if (e.key === 'Escape') {
                    overlay.userChoice = false;
                    overlay.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);

            // Wait for modal to be removed, then resolve with user choice
            const observer = new MutationObserver((mutations) => {
                if (!document.body.contains(overlay)) {
                    observer.disconnect();
                    document.removeEventListener('keydown', escHandler);
                    resolve(overlay.userChoice);
                }
            });
            observer.observe(document.body, { childList: true });
        });
    }

    window.showCustomConfirm = showCustomConfirm;

    document.addEventListener('DOMContentLoaded', () => {
        const userInfoSpan = document.getElementById('userInfoSpan');
        const logoutLink = document.getElementById('logout-link');

        // Verify current session via backend
        async function checkAuth() {
            try {
                const res = await fetch('api/me.php');
                const data = await res.json();
                if (!data.ok || !data.user || data.user.role !== 'ABC') {
                    showCustomAlert('Access Denied. Please login as ABC.', 'error', function() {
                        window.location.href = 'index.html';
                    });
                    return null;
                }
                return data.user;
            } catch (e) {
                showCustomAlert('Unable to verify session.', 'error', function() {
                    window.location.href = 'index.html';
                });
                return null;
            }
        }

        // Logout via backend
        logoutLink.addEventListener('click', async (e) => {
            e.preventDefault();
            try { await fetch('api/logout.php', { method: 'POST' }); } catch {}
            window.location.href = 'index.html';
        });

        // Users table and form handlers using backend API
        const addUserForm = document.getElementById('addUserForm');
        const userTableBody = document.getElementById('userTableBody');
        const userMessage = document.getElementById('userMessage');

        async function loadUsers() {
            try {
                const res = await fetch('api/users.php');
                const data = await res.json();
                if (!data.ok) throw new Error(data.error || 'Failed to load users');
                userTableBody.innerHTML = '';
                data.users.forEach(user => {
                    const row = userTableBody.insertRow();
                    
                    // Display activity status for all users
                    let statusDisplay = '';
                    if (user.role === 'ABC') {
                        statusDisplay = '<span class="status-badge status-approved">ABC Admin</span>';
                    } else {
                        // Show activity status for Barangay Secretaries
                        const activityStatus = user.activity_status || 'Never active';
                        let statusClass = 'status-pending';
                        
                        // Color code based on activity recency - more precise ranges
                        if (activityStatus.includes('now')) {
                            statusClass = 'status-approved'; // Green - active right now
                        } else if (activityStatus.includes('minute')) {
                            // Extract minute number for more precise coloring
                            const minuteMatch = activityStatus.match(/(\d+)\s+minute/);
                            const minutes = minuteMatch ? parseInt(minuteMatch[1]) : 0;
                            
                            if (minutes <= 15) {
                                statusClass = 'status-approved'; // Green - within 15 minutes
                            } else if (minutes <= 30) {
                                statusClass = 'status-review'; // Yellow - 16-30 minutes
                            } else {
                                statusClass = 'status-pending'; // Light - 31-59 minutes
                            }
                        } else if (activityStatus.includes('hour')) {
                            statusClass = 'status-pending'; // Light - hours ago
                        } else {
                            statusClass = 'status-rejected'; // Gray - days or never
                        }
                        
                        statusDisplay = `<span class="status-badge ${statusClass}">${activityStatus}</span>`;
                    }
                    
                    // include data-id to make delete/archive requests more reliable
                    row.innerHTML = `
                        <td>${user.email}</td>
                        <td>${user.barangay}</td>
                        <td>${user.role}</td>
                        <td>${statusDisplay}</td>
                        <td>${user.role !== 'ABC' ? '<button class="delete archive-user-btn" data-id="' + user.id + '" data-email="' + user.email + '">Archive</button>' : ''}</td>
                    `;
                });
                document.querySelectorAll('.archive-user-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const email = this.getAttribute('data-email');
                        const id = this.getAttribute('data-id');
                        const proceed = await showCustomConfirm(`Are you sure you want to archive user: ${email || id}?`, 'warning');
                        if (!proceed) return;
                        try {
                            // Prefer deleting by id for reliability when available
                            const url = id ? `api/users.php?id=${encodeURIComponent(id)}` : `api/users.php?email=${encodeURIComponent(email)}`;
                            const res = await fetch(url, { method: 'DELETE', credentials: 'same-origin' });
                            const data = await res.json();
                            if (!data.ok) throw new Error(data.error || 'Archive failed');
                            userMessage.textContent = `User ${email || id} successfully archived.`;
                            userMessage.style.color = 'green';
                            userMessage.style.display = 'block';
                            setTimeout(() => {
                                userMessage.style.display = 'none';
                            }, 2000);
                            loadUsers();
                            loadArchivedUsers();
                            // Immediately refresh dashboard to reflect archived user's data removal
                            await loadAllSubmissions();
                        } catch (err) {
                            userMessage.textContent = err.message;
                            userMessage.style.color = 'red';
                            userMessage.style.display = 'block';
                            setTimeout(() => {
                                userMessage.style.display = 'none';
                            }, 2000);
                        }
                    });
                });
            } catch (err) {
                userMessage.textContent = err.message;
                userMessage.style.color = 'red';
                userMessage.style.display = 'block';
                setTimeout(() => {
                    userMessage.style.display = 'none';
                }, 2000);
            }
        }

        // Load archived users
        async function loadArchivedUsers() {
            const archivedUserTableBody = document.getElementById('archivedUserTableBody');
            const userMessage = document.getElementById('userMessage');
            try {
                const res = await fetch('api/users.php?archived=1');
                const data = await res.json();
                if (!data.ok) throw new Error(data.error || 'Failed to load archived users');
                archivedUserTableBody.innerHTML = '';
                data.users.forEach(user => {
                    const row = archivedUserTableBody.insertRow();
                    // include id attribute for reliable permanent delete
                    row.innerHTML = `
                        <td>${user.email}</td>
                        <td>${user.barangay}</td>
                        <td>${user.role}</td>
                        <td><span class="status-badge status-rejected">Archived</span></td>
                        <td>
                            <button class="approve restore-btn" data-email="${user.email}">Restore</button>
                            <button class="delete permanent-delete-btn" data-id="${user.id}" data-email="${user.email}" style="margin-left: 5px;">Delete</button>
                        </td>
                    `;
                });
                
                // Restore button handler
                document.querySelectorAll('#archivedUserTableBody .restore-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const email = this.getAttribute('data-email');
                        const proceed = await showCustomConfirm(`Are you sure you want to restore user: ${email}?`, 'info');
                        if (!proceed) return;
                        try {
                            const res = await fetch('api/users.php', {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ email: email, action: 'restore' })
                            });
                            const data = await res.json();
                            if (!data.ok) throw new Error(data.error || 'Restore failed');
                            userMessage.textContent = `User ${email} successfully restored.`;
                            userMessage.style.color = 'green';
                            userMessage.style.display = 'block';
                            setTimeout(() => {
                                userMessage.style.display = 'none';
                            }, 2000);
                            loadUsers();
                            loadArchivedUsers();
                            // Immediately refresh dashboard to show restored user's data
                            await loadAllSubmissions();
                        } catch (err) {
                            userMessage.textContent = err.message;
                            userMessage.style.color = 'red';
                            userMessage.style.display = 'block';
                            setTimeout(() => {
                                userMessage.style.display = 'none';
                            }, 2000);
                        }
                    });
                });
                
                // Delete button handler (permanent delete)
                document.querySelectorAll('#archivedUserTableBody .permanent-delete-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const email = this.getAttribute('data-email');
                        const id = this.getAttribute('data-id');
                        const firstConfirm = await showCustomConfirm(`‚ö†Ô∏è WARNING: Are you sure you want to PERMANENTLY DELETE user: ${email || id}?<br><br>This action CANNOT be undone!<br><br>All data associated with this user will be permanently removed.`, 'error');
                        if (!firstConfirm) return;
                        
                        // Second confirmation for safety
                        const finalConfirm = await showCustomConfirm(`FINAL CONFIRMATION: Delete ${email || id} permanently?`, 'error');
                        if (!finalConfirm) return;
                        
                        try {
                            const url = id ? `api/users.php?id=${encodeURIComponent(id)}&permanent=1` : `api/users.php?email=${encodeURIComponent(email)}&permanent=1`;
                            const res = await fetch(url, { method: 'DELETE', credentials: 'same-origin' });
                            const data = await res.json();
                            if (!data.ok) throw new Error(data.error || 'Delete failed');
                            userMessage.textContent = `User ${email || id} permanently deleted.`;
                            userMessage.style.color = 'green';
                            userMessage.style.display = 'block';
                            setTimeout(() => {
                                userMessage.style.display = 'none';
                            }, 2000);
                            loadUsers();
                            loadArchivedUsers();
                        } catch (err) {
                            userMessage.textContent = err.message;
                            userMessage.style.color = 'red';
                            userMessage.style.display = 'block';
                            setTimeout(() => {
                                userMessage.style.display = 'none';
                            }, 2000);
                        }
                    });
                });
            } catch (err) {
            }
        }

        // Delete reset request function
        async function deleteResetRequest(requestId, email) {
            const proceed = await showCustomConfirm(`Are you sure you want to delete the password reset request for ${email}?`, 'warning');
            if (!proceed) {
                return;
            }
            
            try {
                const response = await fetch(`api/get_reset_requests.php?id=${requestId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    showCustomAlert(`Password reset request deleted successfully for ${email}`, 'success');
                    await loadResetRequests(currentResetFilter);
                } else {
                    showCustomAlert('Failed to delete request: ' + result.error, 'error');
                }
            } catch (error) {
                showCustomAlert('Error deleting request. Please try again.', 'error');
            }
        }

        addUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('userEmail').value.trim().toLowerCase();
            const role = document.getElementById('userRole').value;
            const password = document.getElementById('userPassword').value.trim();
            const confirmPassword = document.getElementById('userConfirmPassword').value.trim();
            const barangay = document.getElementById('userBarangay').value;

            if (!barangay) {
                userMessage.textContent = 'Please select a Barangay.';
                userMessage.style.color = 'red';
                userMessage.style.display = 'block';
                setTimeout(() => {
                    userMessage.style.display = 'none';
                }, 2000);
                return;
            }

            // Check if barangay already has a user
            try {
                const checkRes = await fetch('api/users.php');
                const checkData = await checkRes.json();
                if (checkData.ok && checkData.users) {
                    const existingUser = checkData.users.find(user => user.barangay === barangay && user.archived === '0');
                    if (existingUser) {
                        userMessage.textContent = `A user account already exists for ${barangay} barangay (Email: ${existingUser.email})`;
                        userMessage.style.color = 'red';
                        userMessage.style.display = 'block';
                        setTimeout(() => {
                            userMessage.style.display = 'none';
                        }, 3000);
                        return;
                    }
                }
            } catch (checkErr) {
                // Continue with form submission if check fails
            }

            if (password !== confirmPassword) {
                userMessage.textContent = 'Passwords do not match. Please try again.';
                userMessage.style.color = 'red';
                userMessage.style.display = 'block';
                setTimeout(() => {
                    userMessage.style.display = 'none';
                }, 2000);
                return;
            }

      if (password.length < 8) {
        userMessage.textContent = 'Password must be at least 8 characters long.';
                userMessage.style.color = 'red';
                userMessage.style.display = 'block';
                setTimeout(() => {
                    userMessage.style.display = 'none';
                }, 2000);
                return;
            }

            try {
                const res = await fetch('api/users.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, barangay, role })
                });
                const data = await res.json();
                if (!data.ok) throw new Error(data.error || 'Failed to add user');
                userMessage.textContent = `Successfully added new user for ${barangay}. Email: ${email}`;
                userMessage.style.color = 'green';
                userMessage.style.display = 'block';
                setTimeout(() => {
                    userMessage.style.display = 'none';
                }, 2000);
                addUserForm.reset();
                loadUsers();
                loadArchivedUsers();
            } catch (err) {
                userMessage.textContent = err.message;
                userMessage.style.color = 'red';
                userMessage.style.display = 'block';
                setTimeout(() => {
                    userMessage.style.display = 'none';
                }, 2000);
            }
        });

        // Sidebar navigation
        const sidebarLinks = document.querySelectorAll('.sidebar a.sidebar-link'); 
        const contentCards = document.querySelectorAll('.content-area .card');
        function showContent(targetId) {
            contentCards.forEach(card => card.classList.remove('active-card'));
            document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
            const targetCard = document.getElementById(targetId);
            if (targetCard) targetCard.classList.add('active-card');
            const activeLink = document.querySelector(`.sidebar a[data-target="${targetId}"]`);
            if (activeLink) activeLink.classList.add('active');
            
            // Refresh dashboard data when dashboard is clicked
            if (targetId === 'dashboard') {
                loadAllSubmissions();
            }
            
            // Load reset requests when showing reset-requests section
            if (targetId === 'reset-requests') {
                loadResetRequests(currentResetFilter);
            }
        }
        sidebarLinks.forEach(link => link.addEventListener('click', (event) => {
            event.preventDefault();
            showContent(event.currentTarget.getAttribute('data-target'));
        }));

        // Show/Hide Password functionality
        const showPasswordCheckbox = document.getElementById('showPasswordCheckbox');
        const userPassword = document.getElementById('userPassword');
        const userConfirmPassword = document.getElementById('userConfirmPassword');
        
        if (showPasswordCheckbox) {
            showPasswordCheckbox.addEventListener('change', function() {
                const type = this.checked ? 'text' : 'password';
                userPassword.type = type;
                userConfirmPassword.type = type;
            });
        }

        // Password Reset Requests Functions
        let currentResetFilter = 'pending';
        let currentRequestToReject = null;

        async function loadResetRequests(filter = 'pending') {
            try {
                const response = await fetch(`api/get_reset_requests.php?status=${filter}`);
                const result = await response.json();
                
                if (result.ok) {
                    displayResetRequests(result.requests);
                    
                    // Update sidebar badge with pending count only
                    updateSidebarBadge('resetRequestsNotifBadge', result.pending_count || 0);
                    
                    // Always fetch all requests to get accurate counts for all tabs
                    const allResponse = await fetch('api/get_reset_requests.php?status=all');
                    const allResult = await allResponse.json();
                    
                    if (allResult.ok) {
                        const pCount = allResult.requests.filter(r => r.status === 'pending').length;
                        const aCount = allResult.requests.filter(r => r.status === 'approved').length;
                        const rCount = allResult.requests.filter(r => r.status === 'rejected').length;
                        
                        document.getElementById('reset-pending-count').textContent = pCount;
                        document.getElementById('reset-approved-count').textContent = aCount;
                        document.getElementById('reset-rejected-count').textContent = rCount;
                    }
                }
            } catch (error) {
                console.error('Error loading reset requests:', error);
            }
        }

        function displayResetRequests(requests) {
            const tbody = document.getElementById('reset-requests-tbody');
            
            if (requests.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 20px; text-align: center; color: #666;">
                            No ${currentResetFilter === 'all' ? '' : currentResetFilter} requests found.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = requests.map(req => {
                const requestDate = new Date(req.requested_at);
                const dateStr = requestDate.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const statusClass = `status-${req.status}`;
                const statusText = req.status.charAt(0).toUpperCase() + req.status.slice(1);
                
                let actionsHtml = '';
                if (req.status === 'pending') {
                    actionsHtml = `
                        <button class="action-btn approve-btn" onclick="approveResetRequest(${req.id}, '${req.user_email}')">
                            Approve
                        </button>
                        <button class="action-btn reject-btn" onclick="openRejectionModal(${req.id}, '${req.user_email}')">
                            Reject
                        </button>
                    `;
                } else {
                    actionsHtml = `
                        <span style="color: ${req.status === 'approved' ? '#28a745' : '#dc3545'}; margin-right: 10px;">
                            ${req.status === 'approved' ? '‚úì Approved' : '‚úó Rejected'}
                        </span>
                        <button class="action-btn delete" onclick="deleteResetRequest(${req.id}, '${req.user_email}')">
                            Delete
                        </button>
                    `;
                }
                
                return `
                    <tr>
                        <td style="padding: 12px; border: 1px solid #ddd;">${req.user_email}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${req.user_role}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${req.user_barangay}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${dateStr}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                            ${actionsHtml}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function approveResetRequest(requestId, email) {
            const proceed = await showCustomConfirm(`Are you sure you want to approve the password reset request for ${email}?`, 'info');
            if (!proceed) {
                return;
            }
            
            try {
                const response = await fetch('api/approve_reset_request.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        request_id: requestId,
                        action: 'approve'
                    })
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    showCustomAlert(`Password reset request approved successfully for ${email}`, 'success');
                    await loadResetRequests(currentResetFilter);
                } else {
                    showCustomAlert('Failed to approve request: ' + result.error, 'error');
                }
            } catch (error) {
                showCustomAlert('Error approving request. Please try again.', 'error');
            }
        }

        function openRejectionModal(requestId, email) {
            currentRequestToReject = requestId;
            document.getElementById('reject-modal-email').textContent = email;
            document.getElementById('rejection-modal').style.display = 'flex';
        }

        function closeRejectionModal() {
            currentRequestToReject = null;
            document.getElementById('rejection-modal').style.display = 'none';
        }

        async function submitRejection() {
            try {
                const response = await fetch('api/approve_reset_request.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        request_id: currentRequestToReject,
                        action: 'reject'
                    })
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    showCustomAlert(`Password reset request rejected for ${result.user_email}`, 'success');
                    closeRejectionModal();
                    await loadResetRequests(currentResetFilter);
                } else {
                    showCustomAlert('Failed to reject request: ' + result.error, 'error');
                }
            } catch (error) {
                showCustomAlert('Error rejecting request. Please try again', 'error');
            }
        }

        // Make functions global so they can be called from onclick handlers
        window.approveResetRequest = approveResetRequest;
        window.openRejectionModal = openRejectionModal;
        window.closeRejectionModal = closeRejectionModal;
        window.submitRejection = submitRejection;
        window.deleteResetRequest = deleteResetRequest;

        // Add event listeners for reset request filter buttons
        document.querySelectorAll('.reset-filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.reset-filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentResetFilter = this.getAttribute('data-filter');
                loadResetRequests(currentResetFilter);
            });
        });

        // Auto-refresh user lists every 15 seconds
        setInterval(async () => {
            await loadUsers();
            await loadArchivedUsers();
        }, 15000);

        // Auto-refresh reset requests every 15 seconds (only if on that tab)
        setInterval(async () => {
            const resetRequestsCard = document.getElementById('reset-requests');
            if (resetRequestsCard && resetRequestsCard.classList.contains('active-card')) {
                await loadResetRequests(currentResetFilter);
            }
        }, 15000);

        (async () => {
            const user = await checkAuth();
            if (!user) return;
            userInfoSpan.textContent = 'ABC';
            await loadUsers();
            await loadArchivedUsers();
            await loadAllSubmissions();
            await loadResetRequests('pending');
            initializeBarangaySearch(); // Initialize search functionality
            showContent('dashboard');
        })();
    });

  </script>
</body>
</html>